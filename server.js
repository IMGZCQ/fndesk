let http=require("http"),fs=require("fs"),path=require("path"),url=require("url"),systemStatus={ready:!1,targetUrl:process.env.wizard_fndesk_index||"index.html"},getBeijingTime=()=>new Intl.DateTimeFormat("zh-CN",{timeZone:"Asia/Shanghai",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).format(new Date).replace(/\//g,"-")+" - ",fndata=`${process.env.TRIM_APPDEST_VOL}/@appshare/${process.env.TRIM_APPNAME}/deskdata`,fn_www="/usr/trim/www",fn_res="/usr/trim/share/.restore",fn_media="/var/apps/trim.media/target",pathMappings=[{mapPath:"/deskdata",localDir:fndata},{mapPath:"/fnw",localDir:fn_www},{mapPath:"/res",localDir:fn_res},{mapPath:"/trim.media",localDir:fn_media}],apiDir=path.join(__dirname,"api"),sysicoApi=(fs.existsSync(apiDir)||fs.mkdirSync(apiDir,{recursive:!0}),require("./api/sysico.js")),DATA_FILE_PATH=path.join(fndata,"data.json"),IMG_DIR_PATH=path.join(fndata,"img"),PW_FILE_PATH=path.join(fndata,"pw.json"),FNSTYLE_FILE_PATH=path.join(fndata,"fnstyle.json");function simpleEncrypt(t){var n="deskmanager";let s="";for(let e=0;e<t.length;e++)s+=String.fromCharCode(t.charCodeAt(e)^n.charCodeAt(e%n.length));return Buffer.from(s).toString("base64")}function simpleDecrypt(e){var t="deskmanager",n=Buffer.from(e,"base64").toString();let s="";for(let e=0;e<n.length;e++)s+=String.fromCharCode(n.charCodeAt(e)^t.charCodeAt(e%t.length));return s}function ensurePasswordFile(){try{fs.existsSync(PW_FILE_PATH)||ensureDirectoryExists(path.dirname(PW_FILE_PATH))}catch(e){console.error("创建密码文件失败:",e)}}function downloadFileFromUrl(r,a){return new Promise((t,n)=>{var e=require("https"),e=r.startsWith("https")?e:require("http");let s=fs.createWriteStream(a),i=e.get(r,{timeout:1e4,headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"}},e=>{if(200!==e.statusCode){if(e.resume(),s.close(),fs.existsSync(a))try{fs.unlinkSync(a)}catch(e){console.error("删除失败的文件时出错:",e)}n(new Error("下载文件失败，状态码: "+e.statusCode))}else e.pipe(s),s.on("finish",()=>{s.close(),fs.existsSync(a)?0===fs.statSync(a).size?(fs.unlinkSync(a),n(new Error("下载的文件为空"))):(fs.chmodSync(a,420),t(a)):n(new Error("文件保存失败"))})});i.on("error",e=>{if(s.close(),fs.existsSync(a))try{fs.unlinkSync(a)}catch(e){console.error("删除失败的文件时出错:",e)}n(e)}),i.on("timeout",()=>{if(i.destroy(),s.close(),fs.existsSync(a))try{fs.unlinkSync(a)}catch(e){console.error("删除失败的文件时出错:",e)}n(new Error("下载文件超时"))})})}function readData(){try{if(!fs.existsSync(DATA_FILE_PATH))return ensureDirectoryExists(path.dirname(DATA_FILE_PATH)),fs.writeFileSync(DATA_FILE_PATH,JSON.stringify([]),"utf8"),[];try{var e=fs.readFileSync(DATA_FILE_PATH);try{var t=e.toString("utf8");return JSON.parse(t)}catch(e){return console.warn("使用utf8编码解析失败，尝试修复编码问题:",e),[]}}catch(e){return console.error("读取文件失败:",e),[]}}catch(e){return console.error("读取数据出错:",e),[]}}function writeData(e){try{return ensureDirectoryExists(path.dirname(DATA_FILE_PATH)),fs.writeFileSync(DATA_FILE_PATH,JSON.stringify(e,null,2),"utf8"),!0}catch(e){return console.error("写入数据出错:",e),!1}}function updateTargetPort(t){try{var n=path.join(process.env.TRIM_APPDEST,"ui","index.cgi");if(!fs.existsSync(n))return console.error("文件不存在: "+n),!1;let e=fs.readFileSync(n,"utf8");var s=/TARGET_PORT="(\d+)"/g;return e=e.replace(s,`TARGET_PORT="${t}"`),fs.writeFileSync(n,e,"utf8"),fs.chmodSync(n,493),!0}catch(e){return console.error("修改TARGET_PORT失败:",e),!1}}function getFaviconUrl(e){try{var t,n=new URL(e),s=n.protocol,i=n.host,r={primary:s+`//${i}/favicon.ico`,secondary:null},a=i.split(".");return 3<=a.length&&(t=a[a.length-2]+"."+a[a.length-1],r.secondary=s+`//${t}/favicon.ico`),r}catch(e){return console.error("解析URL出错:",e),{primary:null,secondary:null}}}function fndesk_Xplan_set(){try{let n=require("fs"),s=require("path");let i=s.join("/usr/trim/share/.restore","tow","assets");if(n.existsSync(i)){var r=n.readdirSync(i).filter(e=>e.endsWith(".js")).map(e=>{var t=s.join(i,e);return{file:e,filePath:t,size:n.statSync(t).size}}).sort((e,t)=>t.size-e.size);if(0!==r.length){var a=r[0];let e=n.readFileSync(a.filePath,"utf8"),t="";if(n.existsSync(FNSTYLE_FILE_PATH))try{var o=n.readFileSync(FNSTYLE_FILE_PATH,"utf8"),c=JSON.parse(o);c.copyright&&(t=c.copyright)}catch(e){}e=e.replace(/(jsx\("div",\{className:"text-\[12px\] leading-4 text-text-2",)(.*?)(\}\)\]\}\)\]\}\)\},)/s,`$1dangerouslySetInnerHTML: {__html: "Copyright © 广州铁刃智造技术有限公司 版权所有<br>${t}"}$3`),n.writeFileSync(a.filePath,e,"utf8")}}}catch(e){}}function fndesk_share_page(){try{let i=path.join(fn_res,"tow","modules","trim_sharelink","s","static","0.1.2");if(fs.existsSync(i)&&fs.existsSync(FNSTYLE_FILE_PATH)){var J=fs.readFileSync(FNSTYLE_FILE_PATH,"utf8");let l=JSON.parse(J);if(l.fndeskMP3)try{var t=l.fndeskMP3,n=path.join(process.env.TRIM_APPDEST,"MP3"),e=path.join(process.env.TRIM_APPDEST,"MP3.json");try{if(fs.existsSync(t)&&fs.statSync(t).isDirectory()){let e=!1;try{fs.lstatSync(n),e=!0}catch(e){}if(e)try{fs.unlinkSync(n)}catch(e){console.error("删除旧软链接失败:",e.message)}fs.symlinkSync(t,n)}}catch(e){console.error("创建软链接失败:",e.message)}if(fs.existsSync(t)){if(fs.existsSync(e))try{fs.unlinkSync(e)}catch(e){console.error("删除现有MP3.json失败:",e)}var M=function getAllMusicFiles(r,a=""){let o=[];try{fs.readdirSync(r).forEach(t=>{try{var e,n=path.join(r,t),s=fs.lstatSync(n),i=path.join(a,t).replace(/\\/g,"/");if(s.isDirectory())try{fs.statSync(n).isDirectory()&&(o=o.concat(getAllMusicFiles(n,i)))}catch(e){console.warn("跳过无法访问的目录: "+n)}else s.isFile()&&(e=path.extname(t).toLowerCase(),[".mp3",".wav",".flac",".ape",".aac",".ogg",".m4a",".aif",".aiff"].includes(e))&&o.push(i)}catch(e){console.error(`处理文件 ${t} 时出错:`,e.message)}})}catch(e){console.error(`读取目录 ${r} 时出错:`,e.message)}return o}(t),I=JSON.stringify(M,null,2);fs.writeFileSync(e,I,"utf8"),fs.chmodSync(e,420)}var s=path.join(__dirname,"MP3go"),U=path.join(fn_res,"tow","MP3go");fs.existsSync(s)&&!function copyDirectory(n,s){fs.existsSync(s)||fs.mkdirSync(s,{recursive:!0,mode:493}),fs.readdirSync(n).forEach(e=>{var t=path.join(n,e),e=path.join(s,e);fs.statSync(t).isDirectory()?copyDirectory(t,e):(fs.copyFileSync(t,e),fs.chmodSync(e,420))})}(s,U)}catch(e){console.error("处理MP3设置失败:",e)}if(void 0!==l.fndeskLoginVW||void 0!==l.fndeskLoginVH)try{let e=path.join(fn_res,"tow","assets");if(fs.existsSync(e)){var r=fs.readdirSync(e).filter(e=>e.startsWith("login-form-")&&e.endsWith(".css"));if(0<r.length){let o=l.fndeskLoginVW||0,c=l.fndeskLoginVH||0;r.forEach(t=>{var n=path.join(e,t);try{let e=fs.readFileSync(n,"utf8");var s=/\.gradient-border\b[^:]*\{[^}]*\}/g,i=`.gradient-border{position: relative;margin-left:${o}vw;margin-top:${c}vh}`;e=e.replace(s,i),fs.writeFileSync(n,e,"utf8"),fs.chmodSync(n,420);try{var r,a=path.join(fn_www,"assets");fs.existsSync(a)&&(r=path.join(a,t),fs.copyFileSync(n,r),fs.chmodSync(r,420))}catch(e){console.error(`复制${t}到fnw/assets目录失败:`,e)}}catch(e){console.error(`修改${t}文件失败:`,e)}})}}}catch(e){console.error("处理登录框位置设置失败:",e)}if(l.loginOpacity)try{let r=path.join(fn_res,"tow","assets");if(fs.existsSync(r)){var a=fs.readdirSync(r).filter(e=>e.endsWith(".css"));if(0<a.length){let s=null,i=-1;if(a.forEach(t=>{var e=path.join(r,t);try{var n=fs.statSync(e);n.size>i&&(i=n.size,s=t)}catch(e){console.error(`获取${t}文件大小失败:`,e)}}),s){var o=path.join(r,s);try{let e=fs.readFileSync(o,"utf8");var z=/--un-backdrop-blur:\s*blur\(([^)]*)\)/g,R=/\]\{--tw-backdrop-blur:\s*blur\(([^)]*)\)/g,c=l.loginOpacity+"px";e=(e=e.replace(z,`--un-backdrop-blur:blur(${c})`)).replace(R,`]{--tw-backdrop-blur: blur(${c})`),fs.writeFileSync(o,e,"utf8");try{var f,d=path.join(fn_www,"assets");fs.existsSync(d)&&(f=path.join(d,s),fs.copyFileSync(o,f))}catch(e){console.error(`复制${s}到fnw/assets目录失败:`,e)}}catch(e){console.error(`修改${s}文件失败:`,e)}}}}}catch(e){console.error("查找或修改体积最大的css文件时出错:",e)}if(l.loginBackground)try{let e=path.join(fn_res,"tow","assets");fs.existsSync(e)&&fs.readdirSync(e).filter(e=>e.startsWith("login-form")&&e.endsWith(".js")).forEach(t=>{var n=path.join(e,t);try{let e=fs.readFileSync(n,"utf8");var s=/backgroundImage:\s*(`|['"])url\([\s\S]*?\)\1/g,i=l.loginBackground,r="string"!=typeof i||!/^https?:\/\//i.test(i)&&i.includes(":")?i:`${i}${i.includes("?")?"&":"?"}v=`+Date.now();e=e.replace(s,`backgroundImage: \`url("\${
       (() => {
         const targetDomains = ['5ddd.com', 'fnos.net'];
         const currentDomain = window.location.hostname;
         return targetDomains.some(domain => currentDomain.includes(domain))
           ? "/static/bg/wallpaper-1.webp"
           : "${r}"; })()
     }")\``),fs.writeFileSync(n,e,"utf8");try{var a,o=path.join(fn_www,"assets");fs.existsSync(o)&&(a=path.join(o,t),fs.copyFileSync(n,a))}catch(e){console.error(`复制${t}到fnw/assets目录失败:`,e)}}catch(e){console.error(`修改${t}文件失败:`,e)}})}catch(e){console.error("查找或修改login-form相关js文件时出错:",e)}if(l.loginLogo)try{let e=path.join(fn_res,"tow","assets");fs.existsSync(e)&&fs.readdirSync(e).filter(e=>e.startsWith("login-form")&&e.endsWith(".js")).forEach(t=>{var n,s=path.join(e,t);try{let e=fs.readFileSync(s,"utf8");for(n of["o","m"]){var i=new RegExp(`const ${n}=([\\s\\S]*?)(?=,[a-zA-Z]=\\({children)`,"g"),r=l.loginLogo,a="string"!=typeof r||!/^https?:\/\//i.test(r)&&r.includes(":")?r:`${r}${r.includes("?")?"&":"?"}v=`+Date.now();e=e.replace(i,`const ${n}= (() => {
    const targetDomains = ['5ddd.com', 'fnos.net'];
    const currentDomain = window.location.hostname;
    return targetDomains.some(domain => currentDomain.includes(domain))  
      ? "data:image/svg+xml,%3csvg%20width='80'%20height='62'%20viewBox='0%200%2080%2062'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20fill-rule='evenodd'%20clip-rule='evenodd'%20d='M71.7976%200C71.7976%200%2075.7039%207.62011%2073.9143%2012.0592C72.9983%2014.3316%2070.3423%2017.0402%2067.4317%2017.0402H29.3047C23.8248%2017.0402%2019.3824%2021.4416%2019.3824%2026.871V54.5285C19.3824%2058.6549%2022.7586%2062%2026.9234%2062H37.302C40.0054%2062%2042.197%2059.8286%2042.197%2057.1501V50.7825H49.3583C52.0618%2050.7825%2054.2534%2048.6111%2054.2534%2045.9326V40.3721C60.4044%2040.3721%2066.2097%2037.5272%2069.9786%2032.666L70.3048%2032.2452H50.9459C48.2425%2032.2452%2046.0509%2034.4166%2046.0509%2037.0951V41.5972C46.0509%2042.1818%2045.577%2042.6556%2044.9925%2042.6556H38.8896C36.1861%2042.6556%2033.9945%2044.827%2033.9945%2047.5055V51.9695C33.9945%2053.0209%2033.1422%2053.8731%2032.0909%2053.8731H29.4885C28.4372%2053.8731%2027.5849%2053.0209%2027.5849%2051.9695V26.871C27.5849%2025.9299%2028.3549%2025.167%2029.3047%2025.167H70.0777C75.5577%2025.167%2080.0001%2020.7656%2080.0001%2015.3362C80.0001%2010.4052%2077.9446%205.69738%2074.3281%202.34542L71.7976%200ZM6.08573%2012.0965C4.29615%207.65745%208.2025%200.0373473%208.2025%200.0373473L5.67199%202.38276C2.05551%205.73472%200%2010.4425%200%2015.3735C0%2020.8029%204.4424%2025.2044%209.92237%2025.2044H12.3468C12.3657%2022.0411%2013.5657%2019.1578%2015.528%2016.9731C9.05215%2016.4551%206.89556%2014.1053%206.08573%2012.0965Z'%20fill='white'/%3e%3c/svg%3e" : "${a}";
  })()`)}fs.writeFileSync(s,e,"utf8");try{var o,c=path.join(fn_www,"assets");fs.existsSync(c)&&(o=path.join(c,t),fs.copyFileSync(s,o))}catch(e){console.error(`复制${t}到fnw/assets目录失败:`,e)}}catch(e){console.error(`修改${t}文件失败:`,e)}})}catch(e){console.error("查找或修改login-form相关js文件时出错:",e)}if(l.deviceLogo)try{let r=path.join(fn_res,"tow","assets");if(fs.existsSync(r)){var p=fs.readdirSync(r).filter(e=>e.endsWith(".js"));if(0<p.length){let s=null,i=-1;if(p.forEach(t=>{var e=path.join(r,t);try{var n=fs.statSync(e);n.size>i&&(i=n.size,s=t)}catch(e){console.error(`获取${t}文件大小失败:`,e)}}),s){var y=path.join(r,s);try{let e=fs.readFileSync(y,"utf8");var B=/t8=\s*"(.*?)"/g,W=/n8=\s*"(.*?)"/g,V=/LR=\s*"(.*?)"/g,K=/q9=\s*"(.*?)"/g,G=/xN=\s*"(.*?)"/g,Y=/wN=\s*"(.*?)"/g,Q=/kN=\s*"(.*?)"/g,Z=/j6=\s*"(.*?)"/g,h=l.deviceLogo,m="string"!=typeof h||!/^https?:\/\//i.test(h)&&h.includes(":")?h:`${h}${h.includes("?")?"&":"?"}v=`+Date.now();e=(e=(e=(e=(e=(e=(e=(e=e.replace(B,`t8="${m}"`)).replace(W,`n8="${m}"`)).replace(V,`LR="${m}"`)).replace(K,`q9="${m}"`)).replace(G,`xN="${m}"`)).replace(Y,`wN="${m}"`)).replace(Q,`kN="${m}"`)).replace(Z,`j6="${m}"`),fs.writeFileSync(y,e,"utf8");try{var g,u=path.join(fn_www,"assets");fs.existsSync(u)&&(g=path.join(u,s),fs.copyFileSync(y,g))}catch(e){console.error(`复制${s}到fnw/assets目录失败:`,e)}}catch(e){console.error(`修改${s}文件失败:`,e)}}}}}catch(e){console.error("查找或修改体积最大的js文件时出错:",e)}if(l.movieLogo)try{let i=path.join(fn_media,"static","assets");var S=l.movieLogo+"?v="+Date.now();if(fs.existsSync(i)){var w=fs.readdirSync(i).filter(e=>e.endsWith(".js"));if(0<w.length){let n=null,s=-1;if(w.forEach(e=>{var t=path.join(i,e),t=fs.statSync(t);t.size>s&&(s=t.size,n=e)}),n){var v=path.join(i,n);let e=fs.readFileSync(v,"utf8");var X=/\},WDe[\s\S]*?fZ=\(/g;e=e.replace(X,`},WDe=(() => {
                                                const targetDomains = ['5ddd.com', 'fnos.net'];
   const currentDomain = window.location.hostname;
   return targetDomains.some(domain => currentDomain.includes(domain))  
      ? "${S}" : "${S}";
})(),KDe=(() => {
                                                const targetDomains = ['5ddd.com', 'fnos.net'];
   const currentDomain = window.location.hostname;
   return targetDomains.some(domain => currentDomain.includes(domain))  
      ? "${S}" : "${S}";
})(),fZ=(`),fs.writeFileSync(v,e,"utf8"),e=fs.readFileSync(v,"utf8");var j=/__vite__mapDeps.*?\[(.*?)\]/s.exec(e);if(j&&j[1])try{var A=JSON.parse(`[${j[1]}]`).filter(e=>e.endsWith(".js"));if(5<=A.length){var T=A[A.length-5],x=path.join(i,path.basename(T));if(fs.existsSync(x)){let e=fs.readFileSync(x,"utf8");var $=/const f=[\s\S]*?p=\(\)=>/g;e=e.replace($,`const f=(() => {
                                                                const targetDomains = ['5ddd.com', 'fnos.net'];
   const currentDomain = window.location.hostname;
   return targetDomains.some(domain => currentDomain.includes(domain))  
      ? "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAXcAAABsCAMAAACmeAIgAAABHVBMVEUAAABKVWhKVWhKVGhLU2xKVGdJVGhJVGlKVWhEVWlHVWZKVWdJVWhJVGdJVGdKVWhJVGhMVGgrlv9JVWlKVWhKVWYogv0plf1KVWgqmv5JVGhLVWhJVWdKVWwpm/0ql/4qhf4lf/8qlP0qgf4qg/4phv5KVmgqmf4qmv4qif4qgv4okPsqjP0qj/4qmP4qhv4rnP0qnv4qgv4kj/8qj/8qjf4qnP8qjf0qjf4rmv9HVWgrf/0ql/5IVWlKVmcqm/0pgf4wn/8pmv4piP4gn/8qkv4qgv4qlf8piv0pj/xJV2gqhP0qjv4qmP4qmv4qhP4qiv4qnP4qhv4qiP4qlv0qf/4qkP4qkf4qjf4qjP4qg/4qgv4qgf4qnv4qlP1hyv5PAAAATHRSTlMA8tQ8Hnm1l7YPHlrjiGqmW1tf1MQtICDFn0xLly1fPz8Q79+/b+Lfv9+PMO/fb+/v358Qv5+Pj39PS+/PxaaAXxCvrxDfz39gYJaAj4dOrQAADYdJREFUeNrs1L+Kg0AQBvB5hmvERiGNQkC0EYRAMKSdgYVt8/6vcauTu3E2sv654pr5JazimOb7hoAxxvyLcegfXfsKChD9S6tBXJeDWwHmsGdTv9z8CTIQHT9i6U4s+KPGexsin74hZFeDKKfY5xHP4k7Ey3VgDgmpM863AJE77QGidBEwB1w7pz1BqFncieX+B03rtDyx0i0sdJb7eXcXG0DkiU4GZ7n/IXYip3Sw0LoJhS9fy49OyM3Icj/iTvROjn7kIIowJOLhdFQgxnZ+OOPXCMw+DX0qQTw41fVOSIbMct8po0+Vmic6qYlZ7odVJFZXOtmJ5X7SnVZcEyvdgygs95OylgTyEa006heyRCeIlvs+OYeFfPIVG73SSDOch7e4Ey4r4FsEs22sCGeECxmI2++cXylANDRP1GG57/GFK2oQma5Ed1KhZrnvVeOKAkSf6OSKlvs5I4rtlY47yS33k4aQk0/9zZTJTiz3k3pkkr2PVtrLYPKIOuGBvOS95b5DHZKawuKTXZ5qpb2iO+Gfcdz+5wCz6ebfUG5yEGXcCSxUfs0FzKaLSp0NaqVF3MkQzd5yMJv8Z3bf1Jpbb9MwFICP49zsJk1Yiwhd0UQfAAm2l3ITAiQuE0LaI2rf+v9/BhB3Pb7bYVFXPm2T67RV8tnnHMfZc3NcEOWJh1X7i+9wD6QPBAyORkp72B29r76+PeuRp/uXMw2QOLNxAffCggjG/2IxnhwMpqSH/rv33W714wL+a/YSKoiAZWVio2ta1/cmDAw46amNOLACKjthfQ1HYJF46MppCrEw42Jq0pNDBJ+Ik6nusBL9D8FC0h+aqx+oK2KnSBXvu1+7x2s4ChnxM2MQSUv0S27ivbfETcVAhs1EdwaIMdZM1j7zXF6qeN9dwZGoSYAaIulIzwR7yvhv6IiHFmQaHF8L1IyRgngoZe+r4yX2ggRIII6UCDh2VTgxQ+wjQ6dC71qAJhysMPGRQj4xL1zyfgZHoyQhGOhQm8nMTCo4XUMw4dKRrc/Nmko+uMqLiJwqTVkwhelf/gN8HNs7B5W0tM7gmZFmOIle1FFHIcACqknMIhJmVaTSgUTnGXq/B/LEidU7y+wzmGINxC7UFrXSL1MNqkdc6y46jatqNkK7K0ApnBolekfrFZ6rrU4sFZkCdsdVVWVon8cGbn04kLsChMOpYXpvZziDreWMtClSE0FqYUh1n6N2T01NiIX8UN0b1+XByaF7p6W71LZkGDy6yqCyzKcdiMu7qyB0+/xzcqjeKbqpXO+Nx+qgKTTmcjKvvdq56+bjibSgZ2XPVFrl5nByYCCidUd6TUkUzpFzpNpGVobawywxrKhUPqk8BhhMIS6uHr++Xm2329X1No7rMbwL60hCHVU1nrl1sjrO4Bzv9SO1Q4dpppVK0kIagydxN3Xrq9er7XBG8K5Zf5Yx0EkrMozctghNqE51q6ytBmjHasOxKjDA9kNl7vu4eOeRvnG/XI3gvVQzJnNfZzyFvnz3weDDIU4itOM93BJDsZLDUj5n6rP++uB0oxneYNefttH8OPKtbM5d12nWxZJgr86Hgct3mvfNz2zQHivHq5iD1sa572L9ZnPLX/Gb/e8We/o2ssXX30b1nlNvWFeqFeq5bRq+fKdLQmo1q3HPDh2m7k5KbInULgJn9/PVxsoWW+6DVyN6z2ngjUt78oEwZUwt4BM1urJAlknkpVJttEvvs7D1u83NweZN/4PgK0Q99nI07zmN2wE2N2whzPnkwL7aTRAKw743U7bjGA6SspSHzreL/+jjzV/ZPX80ij/9a9G4PdT/iN7+7fsxuoSRvC9pOEvknu54ktDW8cI6yuZGca1ku3OpTeUdf7v2SyFUZiN+bzVjJ3IYkJ8jeMeVY2C6U/vHm395DlOAizSQZZ4QDAd9yT6VSinD0bFqN6XHc/loDO9LFjDliPsu8infA4VGpF21c2E8XE0Cw/KMq9OfSzsN8vhkYe3DeT/OI5EijZnuE9CoMJv64INusz7h7ZNHO54NusZlpJp/DNZ31X75dATvQfPTvKcBHRL3PIcOuc0qUKtXO2mYssWTyLtvgX9w+t3Oubg2DYQB/DNZ0l6ax8Q2ilNo6QNaJ4XqUBTGQBBfUNkYtHP//99hLpfuu/du7SkK+bVNmuS2dr/cK3df9q6Wt9nf+xAOo1ACTdxxn+V77uA9kroqkU07o3/EZ55Y7tpAZGqdv/7YbMzeN81q02xtdlt48L3XUAPVvGM+TvaeakJyMem5oUlNNZExAeZxrFowU2kq980OKrR5xxbNBh5CMOU78OcdzfsPjjyJ7icRtAfE2IFUxWMeF0bIoGtons8kjQ/lDDx7R/P+gyPtOE03Qaad1U6wwGCzyg8ZSDzdbDeM7Za+bWjeb+mrWdQPTLplh9/7+0Njq/mj0MAurCs0QPbIBWbtR0J85WwnXrhUEkYzDBcXb7dbarGG+WzY4IuuqOfdbkwyH3rMYMfJCz4TRcSWzdwRtUVFV0dx3JxnUli15+IEwIdgJ56b9XjOV++JvoF+utVy+v4pvDpDv6ZUI/DBceMdYBDz5o/FTs9+BIYWUa0sMDujdiWSSoQkaZO5uTq9g+28cdaDuv25pQu22rLtV0AZztHx7ijymlr35B3zRC/gXST7TmgjsTiCaKZ77yxfhPUL+5bpzus3ws16pOw3PK4IcfhA4M3PyjeFimUryjtglGf1PnzS5A2nb8AXIV7oS+YH/FXpfhSul06pOst31FRKg+ab3ZWhQcHalKZZz7AtFefEIhyqEfiCJnlwVHeKR2Wm4IsELxYl84A82pNM6frMDIGCQHoBaldi0zDDnxP+Kil7FOElqlQwjzFMXuCTXikg5dzk/S34gshz/0mk9A1f7us9UtrmE/3QYnp3ymMi1H9BIvR1ZjktfXhOyQfAHVKkSQiFtpN7avSOvDN4PwVvpEoLyLo2fc5NbKC/q8cNhErbHOqvvOJdYcuk0YAeIP2qjgFdbFhUE0oXIwMYhJQBCAwNSqXKyJDlh+CLZ1gYBfOxx8sm/Byi/xWFy6wiiQhX+k6Mo6b2Kd8pE3iFKwaIlG8V51deK/hCO8KSxJl757/vXK7SI5kOZl6H+z2wgbaEK/fl9kmqQq7og0FlVku6Bpn33Mm5oono1hn4IjPcr5G4X17GTu2IjVxWy+hZer6JabAoyKyTJm8bizKgUM7FVHRrAuC3A58dMHjfAROubXOoHerNbIXMfDNKYc0M8ys9oFKeKqnmvjuSxQFtQ+Q0cmljIN5DaR2S7Nhv7Qiga/2DTt29w1RJ5b1Dk4I77veUIbnVu67FmSW2QhabpyIDawG+eoD3UpPMd8Ma7tP3d//RQQ85Z1dAuOODbkQgtxaywjANFWA/09n7pVGomg68kRu+p3udPYCHkWlLids0n0lrcTfzReyFsPF3edmsmFFDfq/2Nwl278AbiaETHuaus3wEHDjqUCKsKUKA513KkU77+T1fNzeerZf2Qrikxhm7d7VY0PClOoTpKEvwR8B/UfsNrHsGR2Jz2MOaYgBAUqE7pE7zOXbf8ccwgakQzi/1gEqppp2DJ/BLd4XMqS+pewdHwjGXNL0rJQWGGNun+ZDnqFXJALMENwjomTh7f6U5RRPwRyg3ZGHHVlLd/wWK2uwl2Byn+NGRs3ZMQ0TtjB6XAAysXL1PdakW4JEuL57kXWNzuX9wZIcbbnnJDS70+Qyf2bXziVJdFzUy9O/JccHpdPNe6svFFPyBcwpPioKb+HA9X5lzLZMo/6cgQmGkcNCOkxzqTFSm7d+TMEv5rDG8XFcPEboHBIZLmoglpS+2XK+H4JNAPwdkB4MjXWuZHoTk7iR0uFvAU+J4Mx/e2qHOucdCgjSvpvryqPMslbPGcl1bpBopzKrofbRYrxvR9Fk/apbgldByGySyV3CkWPTTR886ecFX6lmzEaYu2nGSQwnt6BNLJsoBmay1AFJ+Xhv4BH5AMQpB6CE4Uh5BFFXgKU8zl5v5lPhHCJ+I2lXvataY6pWWmGC5NnEBfiF92XrPX3Ak6QaUjEpDQm1AUkzcrpFPpLieb/agkxCQkV7r993hydrMCHyTifc5+QiOtIfBE11kTeZ6skPRcHTPCBwBjoXeaRM/M7ZoX4F3MJAgjhLvwZEoTWu4CVab5c4fmvDfeSYWTrns9qXot6Hi8+ZmfVPl+BLKRb0pHJPqIv+cZJ1OdEIeWkT64E6YxahdNh8M3D8Uc4umSegV/aCmH3dyzR80uaEyK9fVmq6Y+ebBZDPq/Ww3fTeBf4KQH8R1J9HHqyYsV7pFdOecZPw5V4bUIo+yzU4AHmPLEloOYsU7/kWfetbVETy2gpbDGC0r19R3BX2jngZ2qIKKZ8txm90P5oJqpYa16HdfQMvBLGSrt+xlZgEthzP6XGm+rV8VdMUegv1bbjkeQYsHyvEtlc2e7KXwi+2my7Zy9yoeQfHqjla7b/HXVOp1vcI1231NqVetdu/irznoRmO7ebNbfW61e2W0uHZh0TapvrkY32v9Y9tv/wOUq2s7qzaz/xnKicX6ZAgtdvzn+Y+L1vqfZXTx6aMsfTJta5i/wXC6mIw/UuPjyWra5vSWlpaW/4nfYQEJLqjbWbIAAAAASUVORK5CYII=" : "${S}";
})(),e=(() => {
                                                        const targetDomains = ['5ddd.com', 'fnos.net'];
   const currentDomain = window.location.hostname;
   return targetDomains.some(domain => currentDomain.includes(domain))  
      ? "data:image/png;base64,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" : "${S}";
})(),p=()=>`),fs.writeFileSync(x,e,"utf8"),fs.readFileSync(x,"utf8")}else{console.log("倒数第五个JS文件不存在:",x);var F=path.join(i,T);fs.existsSync(F)&&console.log("使用原始路径找到文件:",F)}}else console.log("JS文件依赖数量不足5个，无法获取倒数第五个文件")}catch(e){console.error("解析依赖列表失败:",e)}else console.log("未能匹配到依赖列表"),console.log("文件开头:",e.substring(0,200))}}}}catch(e){console.error("处理movieLogo字段更新时出错:",e)}if(l.movieOpacity)try{let r=path.join(fn_media,"static","assets");if(fs.existsSync(r)){var k=fs.readdirSync(r).filter(e=>e.endsWith(".css"));if(0<k.length){let s=null,i=-1;if(k.forEach(t=>{var e=path.join(r,t);try{var n=fs.statSync(e);n.size>i&&(i=n.size,s=t)}catch(e){console.error(`获取${t}文件大小失败:`,e)}}),s){var P=path.join(r,s);try{let e=fs.readFileSync(P,"utf8");var ee=/\]\{--tw-backdrop-blur:\s*blur\(([^)]*)\)/g,te=l.movieOpacity+"px";e=e.replace(ee,`]{--tw-backdrop-blur: blur(${te})`),fs.writeFileSync(P,e,"utf8")}catch(e){console.error(`修改${s}文件失败:`,e)}}}}}catch(e){console.error("查找或修改体积最大的css文件时出错:",e)}if(l.movieBackground)try{let r=path.join(fn_media,"static","assets"),t=[];if(fs.existsSync(r)&&(t=fs.readdirSync(r).filter(e=>e.endsWith(".webp"))),fs.existsSync(r)){var D=fs.readdirSync(r).filter(e=>e.endsWith(".js"));if(0<D.length){let s=null,i=-1;if(D.forEach(t=>{var e=path.join(r,t);try{var n=fs.statSync(e);n.size>i&&(i=n.size,s=t)}catch(e){console.error(`获取${t}文件大小失败:`,e)}}),s){var ne=path.join(r,s);try{var se=fs.readFileSync(ne,"utf8"),H=/path:"login".*?import\("(\.\/[^\"]+)"\)/.exec(se);if(H&&2<=H.length){var ie=H[1],N=path.join(r,path.basename(ie));if(fs.existsSync(N)){let e=fs.readFileSync(N,"utf8");var re=/(const J=)[\s\S]*?(\{Text:Q\}=A)/g;e=e.replace(re,`$1(() => {
    const targetDomains = ['5ddd.com', 'fnos.net'];
    const currentDomain = window.location.hostname;
    const isTargetDomain = targetDomains.some(domain => currentDomain.includes(domain));
    return isTargetDomain ? "/v/assets/${t[0]}" : "${l.movieBackground}?v=${Date.now()}";
  })(), $2`),fs.writeFileSync(N,e,"utf8")}}}catch(e){console.error(`处理${s}文件失败:`,e)}}}}}catch(e){console.error("查找或修改trim.media相关js文件时出错:",e)}if(l.movieFavicon)try{var O=path.join(fn_media,"static","index.html");if(fs.existsSync(O)){let e=fs.readFileSync(O,"utf8");var ae=`<script>
                                window.addEventListener('load', () => {
const targetDomains = ['5ddd.com', 'fnos.net'];
const currentDomain = window.location.hostname;
const hasTargetDomain = targetDomains.some(domain => currentDomain.includes(domain));
if (!hasTargetDomain) {
        // 移除所有的favicon链接
        const existingFavicons = document.querySelectorAll('link[rel="icon"]');
        existingFavicons.forEach(favicon => favicon.remove());
        // 添加新的favicon链接
        const faviconLink = document.createElement('link');
        faviconLink.rel = 'icon';
        faviconLink.href = '${l.movieFavicon}?v=${Date.now()}';
        document.head.appendChild(faviconLink);
    }
        });
</script>`,E=/(<head>)([\s\S]*?)(<script [^>]*>)/;E.test(e)&&(e=e.replace(E,`$1${ae}$3`)),fs.writeFileSync(O,e,"utf8")}}catch(e){console.error("更新trim.media/static/index.html中的favicon失败:",e)}if(l.webFavicon)try{var C=path.join(fn_res,"tow","index.html");if(fs.existsSync(C)){let e=fs.readFileSync(C,"utf8");var L,oe=/<link\s+rel=["']icon["'].*?>/gi,_=l.webFavicon,ce=`<link rel="icon" href="${"string"!=typeof _||!/^https?:\/\//i.test(_)&&_.includes(":")?_:`${_}${_.includes("?")?"&":"?"}v=`+Date.now()}">`;e=oe.test(e)?e.replace(oe,ce):(L=/<head>\s*/i,e.replace(L,`<head>
    `+ce)),fs.writeFileSync(C,e,"utf8");try{var le,fe=path.join(fn_www);fs.existsSync(fe)&&(le=path.join(fe,"index.html"),fs.copyFileSync(C,le))}catch(e){}}}catch(e){console.error("修改index.html文件时出错:",e)}if(l.appTitle)try{let r=path.join(fn_res,"tow","assets");if(fs.existsSync(r)){var de=fs.readdirSync(r).filter(e=>e.endsWith(".js"));if(0<de.length){let s=null,i=-1;if(de.forEach(t=>{var e=path.join(r,t);try{var n=fs.statSync(e);n.size>i&&(i=n.size,s=t)}catch(e){console.error(`获取${t}文件大小失败:`,e)}}),s){var b=path.join(r,s);try{let e=fs.readFileSync(b,"utf8");var pe=/document\.title=\s*`([^`]*)`/g,ye=l.appTitle;e=e.replace(pe,`document.title=\`${ye}\``),fs.writeFileSync(b,e,"utf8");try{var he,me=path.join(fn_www,"assets");fs.existsSync(me)&&(he=path.join(me,s),fs.copyFileSync(b,he))}catch(e){console.error(`复制${s}到fnw/assets目录失败:`,e)}}catch(e){console.error(`修改${s}文件失败:`,e)}}}}var q=path.join(fn_res,"tow","index.html");if(fs.existsSync(q))try{let e=fs.readFileSync(q,"utf8");var ge=/<\/body>([\s\S]*?)<\/html>/gis,ue=`<script>
      window.addEventListener('load', () => {
        const excludeDomains = ['5ddd.com', 'fnos.net'];
        const currentDomain = window.location.hostname;
        const shouldModify = !excludeDomains.some(domain => currentDomain.includes(domain));       
        if (shouldModify) {
          setTimeout(() => {
            document.title = "${l.appTitle}";
          }, 500);
        }
      });
    </script>`;e=e.replace(ge,`</body>
    ${ue}
</html>`),fs.writeFileSync(q,e,"utf8");try{var Se,we=path.join(fn_www);fs.existsSync(we)&&(Se=path.join(we,"index.html"),fs.copyFileSync(q,Se))}catch(e){console.error("复制index.html到fnw目录失败:",e)}}catch(e){console.error("修改index.html文件失败:",e)}}catch(e){console.error("查找或修改文件时出错:",e)}var ve=fs.readdirSync(i).filter(e=>e.endsWith(".js"));if(0<ve.length){let n=null,s=0;if(ve.forEach(e=>{var e=path.join(i,e),t=fs.statSync(e);t.size>s&&(s=t.size,n=e)}),n){let e=fs.readFileSync(n,"utf8");var je="fndesk_share_main();",Ae=e.indexOf(je),Te=(-1!==Ae&&(e=e.substring(Ae+je.length)),"data:image/png;base64,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"),xe="https://www.fnnas.com/",Fe="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEYAAABHCAYAAAC6cjEhAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAUDSURBVHgB7ZxPaBxVHMe/M8RaJcQ1iEgTcKb14D+wQgte1BX8cxG6WA/ipdmjF02TKh4EEXoQaYP1oiebXkTBYAKemoOrXiwKBtT2YpwpJMVDSZe0tGGb7vR9p7vbmclMMm92d+bt7nxg2cnMbObt9/3+vfdmB8gJRYt74uOTllHTURKfeNEB9otdBnoBDUtwUNUcLNR3Yd7+1LTjfWwHHjtmFW85+FhsFtEfVHQHZ5ZnzNntTooUxvjQMrSbOI3+ESRIxbkH5SgL0sN27pu+eESI8if6VxRS5Hc0pq1S2MEtwuydvvheHfVZsVlA/1MQLvPD3ilrMnjA50pUjydiANGhTyyffPRM8++WMI2YQvcZBEsJoypizrPNmNNypUagHVRRSKGhgYsrjDFlTaC/A21cioYoT7jhCqPpOIIcF+1OzQatEVss5LS49xZMXa+hhBwftSGUdEfHIeT4cOooMsYMciYKR8Mzuhh57kdOEENHTiiJhRl/cAjP7dsNVWH7+EpKImF4wc/eegi/LW9AVVaubOKriYfx5J5dSIK0MBTlm3cewaq4sOqc+2/DFSeJ5UgL8+5rBYyPDmHxr+tQnfOXam5bad2ySAnDmPLmgWF3e6UXLObfO67OdsvGQylh3jg43Npev1FHL3H4wLDU+VLCvPrU/eglRu67+/VeeVqu7bGFYXT3XujwQbkeyAKvGGy7TIaKLYxXFFJ+fiRxKkwDZiK2MbgvLrGFGRv1/1MK9ePUHjfiqyYQAy1LimBnyhBbwgurtdD9zFJ8MRif/ec6ji+shQZmNvZlYdoP7O7uKIQdGJWB1jfiJ4zYwrAm4BeO6gXun/1lfYsoNF+3Ah3L1qpW1jalKnWp7vvibDXyGC9K8bxQFLpb1qKQ7doehpQwX/+6ju//uBZ6bPHvrZVwu37eKbZrdxTSg4gPvr2MVWGWLJjGPQH5QsBa6Ofjo8lHt52Abn1KWMppIYwsiVrOi/HFL9/MVvRhL0+EZCqec2pRzqSTws47LxKGTMD10laXusFsOfxYmAvNCXOe+13OpLMin8GLIBcmgmyjYwxGREHIIC6T3Zo1VzsoLQwr6o8OjUqJwgD/+swltIuyrsTiMIkob3/5f+JM5EVZi5F1HxZwx+fXOiIKUVaYsZjFIUsGlvudXrFQPvh6YUBlYHWLN/HOartbSzg9JQzHY+9/dxlpkLkwnOTiTFvQdbKe/MpUmObinQoj8CCZtqj8woiSopBMWyUryrkU18p7ZqyUZLKpHZTLSpxUCs4GsqJNe0k4VWGCmSdsMouTSyrcXpKqMBwUNpc2OGpWNfCSrgkTNexv5y6nNOlal80lDJRXFbmLomvCNGfoZT8TXJvKiq7aNYWhBUyIkn+npRSKwuVdVW5I0sxpy0EKBG8j8UJRmJI7NZfSCVKLhKq4SFzYhTZy/GhY0jVgCTl+HFT5W4KfkeND07Cg1+uYR46P+ibmdftz0xY+VUFOkwo1cfOnyNefIMeFz33ge+t31+Yx6yehUBGDjPAc64T5EjdbFZezibJ4S+fmFTWpNjRwaQlDv3IcHMWAIsJJ2Y23DXw1uj1jzg6iOI6Go/ZJ05edQ58f03j4xSA80qBKQ7BDHrIT/WCdScvQhoQ4/RqQRaBlTPG6j//wDvC5D+4jDvpFIAoiyhP7hFnZ/rSY0IJ0HaXGD9gLPfSzZNsdD4qhD6v8KAsJchtpusc7b1JbeQAAAABJRU5ErkJggg==",ke="飞牛 fnOS",Pe="正版免费 兼容x86硬件 智能影视刮削 本地AI相册",De=l.sharePcLogo+"?v="+Date.now()||Te,He=l.shareMbUrl||xe,Ne=l.shareMbLogo+"?v="+Date.now()||Fe,Oe=l.shareMbTitle||ke,Ee=l.shareMbDesc||Pe;function safeString(e){return JSON.stringify(String(e)).slice(1,-1)}var Ce=safeString(De),Le=safeString(He),_e=safeString(Ne),be='let fndesk_share_main_pclogo="'+Te+'";\nlet fndesk_share_main_mbURL="'+xe+'";\nlet fndesk_share_main_mblogo="'+Fe+'";\nlet fndesk_share_main_mbtitle="'+ke+'";\nlet fndesk_share_main_mbdesc="'+Pe+"\";\n\nfunction fndesk_share_main() {\n  const currentUrl = window.location.href;\n  const isMatch = currentUrl.includes('5ddd.com') || currentUrl.includes('fnos.net');\n  if (isMatch) {\n  } else {\nfndesk_share_main_mbURL=\""+Le+'";\nfndesk_share_main_mblogo="'+_e+'";\nfndesk_share_main_pclogo="'+Ce+'";\nfndesk_share_main_mbtitle="'+safeString(Oe)+'";\nfndesk_share_main_mbdesc="'+safeString(Ee)+'";\ndocument.querySelector(\'link[rel*="icon"]\')?.remove();\ndocument.head.insertAdjacentHTML(\'beforeend\', \'<link rel="icon" href="'+_e+"\">');\n  }\n}\nfndesk_share_main();"+(e=e.replace(/children:jsxRuntimeExports\.jsx\("img",\{onClick:\(\)=>\{open\("https:\/\/www\.fnnas\.com\/"/g,'children:jsxRuntimeExports.jsx("img",{onClick:()=>{open(fndesk_share_main_mbURL').replace(/no-underline w-full box-border\",href:\"https:\/\/www\.fnnas\.com\/\"/g,'no-underline w-full box-border",href:fndesk_share_main_mbURL').replace(/const appLogo\$1=\"[^\"]*\"/g,"const appLogo$1=fndesk_share_main_mblogo").replace(/,logo=\"[^\"]*\"/g,",logo=fndesk_share_main_pclogo").replace(/text-base font-500\",children:\"飞牛 fnOS\"/g,'text-base font-500",children:fndesk_share_main_mbtitle').replace(/text-xs text-\[var\(--semi-color-primary\)\]\",children:\"正版免费 兼容x86硬件 智能影视刮削 本地AI相册\"/g,'text-xs text-[var(--semi-color-primary)]",children:fndesk_share_main_mbdesc'));fs.writeFileSync(n,be,"utf8")}}else console.log("未找到js文件")}else console.log("目录或文件不存在")}catch(e){console.error("处理外链分享设置时出错:",e)}}function addLoginBeian(t){try{if(fs.existsSync(FNSTYLE_FILE_PATH)){var n,s,e=fs.readFileSync(FNSTYLE_FILE_PATH,"utf8"),i=JSON.parse(e);if(fs.existsSync(t)){let e=fs.readFileSync(t,"utf8");e=(e=e.replace(/<div\s+id="LoginBeian"[^>]*>.*?<\/div>/s,"")).replace(/\n\s*\n/g,"\n"),1===i.beian&&(n=i.beian_Name||"",s=`<div id="LoginBeian" style="position: fixed; left: 50%; bottom: 3%; transform: translateX(-50%); font-weight: bold; font-size: 13px; text-shadow: 1px 1px 3px rgba(0,0,0,0.3); z-index: 9999; text-align: center; color: white; line-height: 1.2;">
  <span class="footer-item">
    <a href="${i.beian_URL||"#"}" target="_blank" style="text-decoration: none; color: inherit;">${n}</a>
  </span>
  <span class="footer-sep" style="margin: 0 5px;">-</span>
  <span class="footer-item">
    <a href="https://beian.miit.gov.cn" target="_blank" style="text-decoration: none; color: inherit;">${i.beian_NUM||""}</a>
  </span>
  <style>
    .footer-item { display: inline-block; }
    @media (max-width: 420px) {
      .footer-item { display: block; }
      .footer-sep { display: none; }
    }
  </style>
  <script>
      const excludeDomains = ['5ddd.com', 'fnos.net'];
      const currentDomain = window.location.hostname;
      const shouldHide = excludeDomains.some(domain => currentDomain.includes(domain));
      const loginBeian = document.getElementById('LoginBeian');
      if (loginBeian && shouldHide) {
        loginBeian.style.display = 'none';
      }
  </script>
</div>`,e=e.replace(/<\/body>/i,s+`
</body>`)),fs.writeFileSync(t,e,"utf8")}}}catch(e){console.error("处理备案信息时出错:",e)}}function modifyHtmlFile(t){try{if(fs.existsSync(t)){let e=fs.readFileSync(t,"utf8");var n=/<body>([\s\S]*)<div id="root">/;return n.test(e)?(e=e.replace(n,`<body>
    <script src="./cqfndesk.js?v=${Date.now()}"></script>
    <div id="root">`),fs.writeFileSync(t,e,"utf8"),addLoginBeian(t),!0):(console.log('未找到匹配的<body>和<div id="root">结构'),!1)}return console.log("目标HTML文件不存在"),!1}catch(e){return console.error("修改HTML文件失败:",e),!1}}function copyIconsDirectory(){var e=path.join(fn_res,"tow","static","app","icons"),t=path.join(fn_www,"static","app","icons");try{return ensureDirectoryExists(t),copyDirectoryRecursive(e,t),!0}catch(e){return!1}}function copyDirectoryRecursive(n,s){fs.readdirSync(n).forEach(e=>{var t=path.join(n,e),e=path.join(s,e);fs.statSync(t).isDirectory()?(ensureDirectoryExists(e),fs.chmodSync(e,493),copyDirectoryRecursive(t,e)):(fs.copyFileSync(t,e),fs.chmodSync(e,420))})}function ensureDirectoryExists(e){fs.existsSync(e)||(fs.mkdirSync(e,{recursive:!0}),safeChmod(e,493))}function safeChmod(t,e){try{return fs.existsSync(t)?(fs.chmodSync(t,e),!0):(console.log("文件不存在，跳过chmod: "+t),!1)}catch(e){return console.error("chmod操作失败: "+t,e.message),!1}}function handleMoveNameDisplay(){try{var e=path.join(fndata,"fnstyle.json");if(fs.existsSync(e)){var n=JSON.parse(fs.readFileSync(e,"utf8")),s=path.join(fn_media,"static","index.html");if(fs.existsSync(s)){let e=fs.readFileSync(s,"utf8");var i=/<\/title>[\s\S]*?<style>/;let t;t=2===n.moveNameDisplay?"</title><script> \n         // 页面加载完毕后移除所有class包含leading-xl的元素 \n window.addEventListener('load', () => { \n   let i = 0; \n   const check = () => { \n     if (i++ < 100) { \n       const els = document.querySelectorAll('.leading-xl.semi-typography-paragraph.semi-typography-primary.semi-typography-normal'); \n       if (els.length) { \n         els.forEach(el => el.parentElement.remove()); \n       } else { \n         setTimeout(check, 100); \n       } \n     } \n   }; \n   check(); \n }); \n     <\/script> \n     <style>":"</title>\n    <style>",e=e.replace(i,t),fs.writeFileSync(s,e,"utf8")}else console.log("trim.media/static/index.html文件不存在")}}catch(e){console.error("处理moveNameDisplay设置时出错:",e)}}function setPermissionsRecursively(t){try{fs.existsSync(t)?(fs.chmodSync(t,493),fs.readdirSync(t).forEach(e=>{e=path.join(t,e);try{fs.lstatSync(e).isDirectory()?setPermissionsRecursively(e):fs.chmodSync(e,420)}catch(e){}})):console.error("目录不存在，跳过权限设置:",t)}catch(e){console.error("设置权限时出错:",e.message)}}function convertDataToConfig(){try{var e=path.join(fndata,"data.json"),t=path.join(__dirname,"config"),n=fs.readFileSync(e,"utf8"),s=JSON.parse(n);let y={".url":{"fndesk_ser.main":{title:"fndesk服务",icon:"images/icon_{0}.png",type:"iframe",port:"9990",url:"/",allUsers:!1,noDisplay:!0}}};s.forEach(r=>{if(1===r.fnAppicon){var n="fndesk_ser."+r.id,s=r.fndata_Title||"",a=r.fndata_LanPic||"",o=1===r.OpenInPage?"iframe":"url";let i="/cgi/ThirdParty/fndesk_ser/index.cgi";var c=r.fndata_Lan||"",r=r.fndata_Wan||"",l=/^\d+/.test(c),f=/^\d+/.test(r);let e=!1,t=null;if(l){l=c.match(/^(\d+)(.*)$/);i=l?(t=l[1],l[2]||"/"):c,e=!0}else if(f){l=r.match(/^(\d+)(.*)$/);i=l?(t=l[1],l[2]||"/"):r,e=!0}else{let e="http",t="",n="http",s="";if(c)try{var d=new URL(c);e=d.protocol.replace(":",""),t=d.host+d.pathname+d.search+d.hash}catch(e){}if(r)try{var p=new URL(r);n=p.protocol.replace(":",""),s=p.host+p.pathname+p.search+p.hash}catch(e){console.warn(`无效外网URL: ${r}，使用默认值`)}(t||s)&&(i+=`?uH1=${encodeURIComponent(e)}&uB1=${encodeURIComponent(t)}&uH2=${encodeURIComponent(n)}&uB2=`+encodeURIComponent(s))}f={title:s,icon:a,type:o,url:i,allUsers:!1};t&&(f.port=t),y[".url"][n]=f}}),fs.writeFileSync(t,JSON.stringify(y,null,4),"utf8")}catch(e){console.error("转换过程中出错:",e.message)}}function handleApiRequest(e,w){var t,n,s,i,a=new URL(e.url,"http://localhost"),r=a.pathname;if("/api/system-status"===r)w.setHeader("Access-Control-Allow-Origin","*"),w.setHeader("Content-Type","application/json"),w.writeHead(200),w.end(JSON.stringify(systemStatus));else{if(!systemStatus.ready)if(!["/loading.html","/api/system-status","/api/update-data"].includes(r))return w.writeHead(302,{Location:"./loading.html"}),void w.end();for(t of pathMappings)if(r.startsWith(t.mapPath)){var o=r.replace(t.mapPath,"");let n=path.join(t.localDir,o);return void fs.readFile(n,(e,t)=>{e?(w.writeHead(404),w.end("文件不存在")):(e=path.extname(n).toLowerCase(),w.writeHead(200,{"Content-Type":{".html":"text/html",".css":"text/css",".js":"text/javascript",".json":"application/json",".png":"image/png",".jpg":"image/jpeg",".jpeg":"image/jpeg",".gif":"image/gif",".svg":"image/svg+xml",".ico":"image/x-icon",".webp":"image/webp"}[e]||"application/octet-stream"}),w.end(t))})}if("/api/getWebpFiles"===r){w.setHeader("Access-Control-Allow-Origin","*"),w.setHeader("Content-Type","application/json; charset=utf-8");try{var l=path.join(fn_media,"static","assets");if(!fs.existsSync(l))return w.writeHead(404),void w.end(JSON.stringify({error:"assets目录不存在"}));var c=fs.readdirSync(l).filter(e=>e.endsWith(".webp"));w.writeHead(200),w.end(JSON.stringify({files:c}))}catch(e){console.error("获取webp文件失败:",e),w.writeHead(500),w.end(JSON.stringify({error:e.message}))}}else if("/api/download-and-install-fpk"===r){systemStatus.ready=!1,w.setHeader("Access-Control-Allow-Origin","*"),w.setHeader("Content-Type","application/json; charset=utf-8");let a=path.join(process.env.TRIM_APPDEST_VOL,"@appshare",process.env.TRIM_APPNAME,"update"),o=path.join(a,"fndesk.tar"),t=path.join(a,"config.env");l=a.match(/\/vol(\d+)\//);let c=l?l[1]:"";try{fs.existsSync(a)||fs.mkdirSync(a,{recursive:!0}),downloadFileFromUrl("https://fndesk.imcq.top/FPK/fndesk.fpk",o).then(()=>{var e=`wizard_fndesk_nouse=1
wizard_fndesk_index=${process.env.wizard_fndesk_index||"index.html"} 
wizard_wan_url=${process.env.wizard_wan_url||""}
wizard_lan_url=${process.env.wizard_lan_url||""}
wizard_app_port=${process.env.wizard_app_port||"9990"}
wizard_data_action=keep
wizard_modules_1111=4
`,e=(fs.writeFileSync(t,e,{encoding:"utf8"}),fs.chmodSync(t,420),require("child_process")).exec;e(`tar -xf ${o} -C `+a,(e,t,n)=>{if(e)console.error("解压FPK文件失败:",e),w.writeHead(500),w.end(JSON.stringify({success:!1,message:"解压FPK文件失败："+e.message}));else{fs.unlink(o,e=>{e&&console.error("删除FPK文件失败:",e)});let s=require("child_process").spawn;var i,r;i="appcenter-cli",r=["default-volume",c],new Promise((t,n)=>{var e=s(i,r,{cwd:a,shell:!0});e.on("close",e=>{0===e?t():n(new Error("Command failed with code "+e))}),e.on("error",e=>{n(e)})}).then(()=>{s("appcenter-cli",["install-local","--env","config.env"],{cwd:a,detached:!0,stdio:"ignore",shell:!0}).unref()}).catch(e=>{console.error("命令执行失败:",e)}),w.writeHead(200),w.end(JSON.stringify({success:!0,message:"FPK文件下载、配置文件创建、解压成功，命令已启动执行"}))}})}).catch(e=>{console.error("FPK文件下载失败:",e),w.writeHead(500),w.end(JSON.stringify({success:!1,message:"FPK文件下载失败："+e.message}))})}catch(e){console.error("处理FPK下载和安装时出错:",e),w.writeHead(500),w.end(JSON.stringify({success:!1,message:"处理过程中出错："+e.message}))}}else if("/api/announcement"===r){w.setHeader("Access-Control-Allow-Origin","*"),w.setHeader("Access-Control-Allow-Methods","GET"),w.setHeader("Content-Type","text/html; charset=utf-8");let t=require("https");void function fetchContent(e){t.get(e,e=>{if(301===e.statusCode||302===e.statusCode){var t=e.headers.location;if(t)return void fetchContent(t)}let n="";e.on("data",e=>{n+=e}),e.on("end",()=>{w.writeHead(e.statusCode,{"Content-Type":"text/html; charset=utf-8"}),w.end(n)})}).on("error",e=>{console.error("获取公告内容失败:",e.message),w.writeHead(500,{"Content-Type":"text/html; charset=utf-8"}),w.end(`<div class="error-message">获取公告失败: ${e.message}</div>`)})}("https://fndesk.imcq.top/?url=gonggao&at=FnAPP&ver="+process.env.TRIM_APPVER)}else if("/api/merge-data"===r&&"POST"===e.method){w.setHeader("Access-Control-Allow-Origin","*"),w.setHeader("Content-Type","application/json; charset=utf-8");let s="";e.on("data",e=>{s+=e.toString()}),void e.on("end",()=>{try{if((s?JSON.parse(s):{}).confirm){console.log("收到带确认标志的数据合并请求，开始执行...");var e=path.join(fndata,"fnicon.json");DATA_FILE_PATH;if(!fs.existsSync(e))throw new Error("fnicon.json文件不存在");var t=JSON.parse(fs.readFileSync(e,"utf8"));if(!Array.isArray(t))throw new Error("fnicon.json格式错误，不是有效的数组");var n=readData();let s=0,i=(0<n.length&&(s=Math.max(...n.map(e=>parseInt(e.id)||0))),0),r=[];if(t.forEach((e,t)=>{s++,i++;let n=e.fndata_LanPic||"";n.includes("/conf/")&&(n=n.replace("/conf/","/deskdata/img/"));e={id:s,fndata_Sort:s,fndata_Type:0,fndata_For:0,fndata_Title:e.fndata_Title||e.title||"",fndata_Wan:e.fndata_Wan||"",fndata_Lan:e.fndata_Lan||"",fndata_WanPic:e.fndata_WanPic||"",fndata_LanPic:n,fndata_URL1:"",fndata_URL2:"",fndata_URL3:""};r.push(e)}),!writeData([...n,...r]))throw new Error("写入数据失败");console.log(`数据合并完成！处理了 ${i} 条记录`),w.writeHead(200),w.end(JSON.stringify({success:!0,processedCount:i,message:"数据合并成功"}))}else console.log("数据合并请求缺少确认标志，拒绝执行"),w.writeHead(400),w.end(JSON.stringify({success:!1,message:"请求缺少确认标志，请确认操作后重试"}))}catch(e){console.error("数据合并失败:",e.message),w.writeHead(500),w.end(JSON.stringify({success:!1,message:e.message}))}})}else if("/api/check-file"===r&&"POST"===e.method){w.setHeader("Content-Type","application/json");let t="";e.on("data",e=>{t+=e.toString()}),void e.on("end",()=>{try{JSON.parse(t);var e=path.join(fn_res,"www.bak");w.writeHead(200),w.end(JSON.stringify({exists:fs.existsSync(e)}))}catch(e){console.error("检查文件时出错:",e),w.writeHead(500),w.end(JSON.stringify({exists:!1,error:e.message}))}})}else if("/api/reset-desktop"===r&&"POST"===e.method){w.setHeader("Content-Type","application/json");try{var f=path.join(fn_res,"www.bak"),d=path.join(fn_res,"www.zip");if(!fs.existsSync(f))return w.writeHead(404),void w.end(JSON.stringify({success:!1,error:"系统源文件不存在！"}));fs.existsSync(d)&&fs.unlinkSync(d),fs.copyFileSync(f,d),fs.chmodSync(d,420),console.log(getBeijingTime()+"还原将在程序重启后执行...");var p=path.join(fn_res,"tow");if(fs.existsSync(p))try{fs.rmSync(p,{recursive:!0,force:!0})}catch(e){console.error("删除res/tow目录时出错:",e.message)}var{existsSync:y,writeFileSync:h}=require("fs"),m=require("path").join,g=path.join(fn_www);y(g)?(h(m(g,"toOK"),"","utf8"),console.log(getBeijingTime()+"系统所有自定义配置已重置！")):console.log("fnw目录不存在，跳过操作"),w.writeHead(200),w.end(JSON.stringify({success:!0,message:"系统还原成功，请稍后刷新桌面。"}))}catch(e){console.error("还原桌面时出错:",e),w.writeHead(500),w.end(JSON.stringify({success:!1,error:e.message}))}}else if("/api/update-data"===r){if("POST"!==e.method)return w.writeHead(405,{"Content-Type":"application/json"}),void w.end(JSON.stringify({success:!1,message:"不支持的请求方法"}));let t="";e.on("data",e=>{t+=e}),void e.on("end",()=>{try{var e,n=JSON.parse(t);if(n.filePath&&n.update){let t;if(t=n.filePath.startsWith("deskdata/")?(e=n.filePath.substring("deskdata/".length),path.join(fndata,e)):path.join(__dirname,n.filePath),fs.existsSync(t)){let e;try{var s=fs.readFileSync(t);e=JSON.parse(s.toString("utf8"))}catch(e){return console.error("解析文件内容失败:",e),w.writeHead(500,{"Content-Type":"application/json"}),void w.end(JSON.stringify({success:!1,message:"解析文件内容失败"}))}Object.assign(e,n.update);try{fs.writeFileSync(t,JSON.stringify(e,null,2),"utf8"),w.writeHead(200,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!0,message:"文件更新成功"}))}catch(e){console.error("写入文件失败:",e),w.writeHead(500,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!1,message:"写入文件失败"}))}}else w.writeHead(404,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!1,message:"文件不存在: "+n.filePath}))}else w.writeHead(400,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!1,message:"缺少必要参数filePath或update"}))}catch(e){console.error("处理更新请求出错:",e),w.writeHead(400,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!1,message:"请求数据格式错误"}))}})}else if(r.startsWith("/api/data"))switch(e.method){case"GET":var u=readData();w.writeHead(200,{"Content-Type":"application/json"}),w.end(JSON.stringify(u));break;case"POST":let r="";e.on("data",e=>{r+=e}),e.on("end",()=>{try{let t=JSON.parse(r);var e,n,s,i;Array.isArray(t)?(e=writeData(t),w.writeHead(200,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:e,message:e?"数据保存成功":"数据保存失败"}))):(-1!==(s=(n=readData()).findIndex(e=>e.id===t.id))?n[s]=t:n.push(t),i=writeData(n),w.writeHead(200,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:i,message:i?"数据保存成功":"数据保存失败"})))}catch(e){console.error("处理POST请求出错:",e),w.writeHead(400,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!1,message:"请求数据格式错误"}))}});break;case"DELETE":let t=a.searchParams.get("id");if(t){var u=readData(),S=u.find(e=>e.id===t);if(S){let e;S=writeData(e=1===S.fndata_Type?u.map(e=>e.fndata_For===t?{...e,fndata_For:0}:e).filter(e=>e.id!==t):u.filter(e=>e.id!==t));w.writeHead(200,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:S,message:S?"数据删除成功，已处理相关归属记录":"数据删除失败"}))}else w.writeHead(200,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!0,message:"记录不存在，无需删除"}))}else w.writeHead(400,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!1,message:"缺少ID参数"}));break;default:w.writeHead(405,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!1,message:"不支持的请求方法"}))}else if("/api/docker/containers"===r&&"GET"===e.method)w.setHeader("Access-Control-Allow-Origin","*"),w.setHeader("Content-Type","application/json"),c=require("child_process").exec,c('docker ps --format "{{.Names}} {{.Ports}}"',(e,t,n)=>{e?(console.error("执行Docker命令失败: "+e.message),w.writeHead(500),w.end(JSON.stringify({error:"获取Docker容器失败"}))):(n&&console.error("Docker命令错误输出: "+n),e=t.trim().split("\n").filter(e=>e.trim()).map(e=>{var e=e.split(/\s+/),t=e[0];let n="";e=e.slice(1).join(" ").match(/(?:0\.0\.0\.0:|\[::\]:)(\d+)(?:-\d+)?->\d+(?:-\d+)?\/tcp/);return{name:t,port:n=e?e[1]:n}}),w.writeHead(200),w.end(JSON.stringify(e)))});else if("/api/download-image"===r){let n="";e.on("data",e=>{n+=e}),void e.on("end",()=>{try{let c=JSON.parse(n),{id:d,imageUrl:e,urls:l=[],type:t}=c,p=e;if(d){ensureDirectoryExists(IMG_DIR_PATH);path.join(IMG_DIR_PATH,0===t?"i.png":"f.png");let r="/deskdata/img/"+(0===t?"i.png":"f.png"),a=1===t?"https://help-static.fnnas.com/images/文件管理.png":"https://help-static.fnnas.com/images/Margin-1.png",f=(c,l)=>new Promise((i,r)=>{try{var t=c.startsWith("https")?require("https"):require("http"),a=path.extname(l)||path.extname(new URL(c).pathname)||".png";let n=""+d+a,s=path.join(IMG_DIR_PATH,n);if(fs.existsSync(s))try{fs.unlinkSync(s)}catch(e){console.warn("删除旧文件失败: "+e.message)}var o={headers:{"User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"},timeout:1e4};let e=t.get(c,o,t=>{if([301,302,303,307,308].includes(t.statusCode)&&t.headers.location)console.log("检测到重定向到: "+t.headers.location),f(t.headers.location,l).then(e=>{e.imageUrl=c,i(e)}).catch(r);else{var e=t.headers["content-type"]||"",e=e.startsWith("image/")||e.includes("svg")||e.includes("xml");if(200===t.statusCode&&e){let e=fs.createWriteStream(s);t.pipe(e),e.on("finish",()=>{e.close();try{if(0===fs.statSync(s).size)fs.unlinkSync(s),r(new Error("下载的文件为空"));else{try{fs.chmodSync(s,"644")}catch(e){console.warn("设置文件权限失败: "+e.message)}i({success:!0,filePath:"/deskdata/img/"+n,imageUrl:c})}}catch(e){r(new Error("文件保存失败: "+e.message))}})}else r(new Error("无效的图片响应: "+t.statusCode))}});e.on("timeout",()=>{console.error("下载图片超时: "+c),e.destroy(),r(new Error("下载超时"))}),e.on("error",e=>{if(console.error("下载图片出错: "+e.message),fs.existsSync(s))try{fs.unlinkSync(s)}catch(e){}r(e)})}catch(e){console.error("下载过程出错: "+e.message),r(e)}}),o=e=>{try{var t,n=new URL(e),s=n.protocol,i=n.host,r={primary:s+`//${i}/favicon.ico`,secondary:null},a=i.split(".");return 3<=a.length&&(t=a[a.length-2]+"."+a[a.length-1],r.secondary=s+`//${t}/favicon.ico`),r}catch(e){return console.error("解析URL错误: "+e.message),{primary:null,secondary:null}}};(async()=>{if(p&&!c.isAutoFetch)try{var e=path.extname(new URL(p).pathname)||".png",t=""+d+e;return await f(p,t)}catch(e){console.error("networkImageUrl下载失败: "+e.message)}for(var n of l){n=o(n);if(n.primary)try{var s=await f(n.primary,d+".ico");return s.imageUrl=n.primary,s}catch(e){if(console.error("Primary favicon下载失败: "+e.message),n.secondary)try{var i=await f(n.secondary,d+".ico");return i.imageUrl=n.secondary,i}catch(e){console.error("Secondary favicon下载失败: "+e.message)}continue}}return{success:!0,filePath:r,imageUrl:c.isAutoFetch?a:null}})().then(e=>{w.writeHead(200,{"Content-Type":"application/json"}),w.end(JSON.stringify(e))}).catch(e=>{console.error("下载流程失败:",e),w.writeHead(500,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!1,message:"图片下载失败，请检查网络连接或URL是否正确",error:e.message}))})}else w.writeHead(400,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!1,message:"缺少必要参数id"}))}catch(e){console.error("处理下载请求出错:",e),w.writeHead(400,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!1,message:"请求数据格式错误"}))}})}else if(r.startsWith("/api/upload")&&!r.startsWith("/api/upload-icon")&&"POST"===e.method){let h="image";l=r.split("/");3<l.length&&(h=l[3]);let m,g=!1;"localImg"===h?(m=path.join(fndata,"img"),g=!0):m=path.join(fndata,"fnstyle"),ensureDirectoryExists(m);f=new(require("formidable").IncomingForm);f.uploadDir=m,f.keepExtensions=!1,f.maxFileSize=52428800,void f.parse(e,(s,i,r)=>{if(s)console.error("文件上传解析错误:",s),w.writeHead(500,{"Content-Type":"application/json"}),w.end(JSON.stringify({error:"文件上传失败: "+s.message}));else{s=Object.keys(r)[0];if(s&&r[s]){let n;r=(n=Array.isArray(r[s])?r[s][0]:r[s]).filepath||n.path;if(fs.existsSync(r)){var s=n.originalFilename||n.name||"unknown";let e=path.extname(s).toLowerCase();e||(s=n.mimetype||"",e=s.includes("png")?".png":s.includes("jpeg")||s.includes("jpg")?".jpg":s.includes("gif")?".gif":s.includes("svg")?".svg":s.includes("ico")?".ico":".png");let t;t=g&&i.id?""+i.id+e:""+h+e;s=path.join(m,t);if(fs.existsSync(s))try{fs.unlinkSync(s)}catch(e){console.error("删除旧文件失败:",e)}try{fs.statSync(r);if(fs.renameSync(r,s),fs.chmodSync(s,420),!fs.existsSync(s))throw new Error("文件重命名后不存在");if("fndesk-app-icon"===h){var a=path.join(__dirname,"fndesk_app"),o=path.join(a,"app","ui"),c=path.join(o,"images");ensureDirectoryExists(a),ensureDirectoryExists(o),ensureDirectoryExists(c);try{var l=path.join(a,"ICON.PNG"),f=path.join(a,"ICON_256.PNG"),d=path.join(c,"icon_64.png"),p=path.join(c,"icon_256.png");fs.copyFileSync(s,l),fs.copyFileSync(s,f),fs.copyFileSync(s,d),fs.copyFileSync(s,p),fs.chmodSync(l,420),fs.chmodSync(f,420),fs.chmodSync(d,420),fs.chmodSync(p,420)}catch(e){console.error("复制fndesk-app-icon到指定位置失败:",e)}}var y=g?"deskdata/img/"+t:"/deskdata/fnstyle/"+t;w.writeHead(200,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!0,path:y,filePath:g?"deskdata/img/"+t:y,fileName:t}))}catch(e){console.error("文件重命名失败:",e),w.writeHead(500,{"Content-Type":"application/json"}),w.end(JSON.stringify({error:"文件处理失败: "+e.message}))}}else console.error("临时文件不存在:",r),w.writeHead(500,{"Content-Type":"application/json"}),w.end(JSON.stringify({error:"临时文件不存在"}))}else console.error("未收到有效文件"),w.writeHead(400,{"Content-Type":"application/json"}),w.end(JSON.stringify({error:"未收到文件"}))}})}else if("/api/update-trim-media-title"===r&&"POST"===e.method){let r="";e.on("data",e=>{r+=e.toString()}),void e.on("end",()=>{try{var t=JSON.parse(r).movieTitle,n=path.join(fn_media,"static","index.html");if(fs.existsSync(n)){let e=fs.readFileSync(n,"utf8");var s=/<\/body>([\s\S]*?)<\/html>/gis,i=`<script>
      window.addEventListener('load', () => {
        const excludeDomains = ['5ddd.com', 'fnos.net'];
        const currentDomain = window.location.hostname;
        const shouldModify = !excludeDomains.some(domain => currentDomain.includes(domain));       
        if (shouldModify) {
            document.title = "${t}";
        }
      });
    </script>`;e=e.replace(s,`</body>
    ${i}
</html>`),fs.writeFileSync(n,e,"utf8"),w.writeHead(200,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!0,message:"trim.media/static/index.html文件已更新"}))}else w.writeHead(404,{"Content-Type":"application/json"}),w.end(JSON.stringify({error:"trim.media/static/index.html文件不存在"}))}catch(e){console.error("更新trim.media/static/index.html文件出错:",e),w.writeHead(500,{"Content-Type":"application/json"}),w.end(JSON.stringify({error:"更新文件失败"}))}})}else{if("/api/fnstyle.json"===r){if(ensureDirectoryExists(path.dirname(FNSTYLE_FILE_PATH)),"GET"===e.method){try{fs.existsSync(FNSTYLE_FILE_PATH)?(n=fs.readFileSync(FNSTYLE_FILE_PATH,"utf8"),s=JSON.parse(n),w.writeHead(200,{"Content-Type":"application/json"}),w.end(JSON.stringify(s))):(i={loginBackground:"",loginLogo:"",deviceLogo:"",appTitle:"",loginOpacity:""},fs.writeFileSync(FNSTYLE_FILE_PATH,JSON.stringify(i,null,2),"utf8"),w.writeHead(200,{"Content-Type":"application/json"}),w.end(JSON.stringify(i)))}catch(e){console.error("读取fnstyle.json文件出错:",e),w.writeHead(500,{"Content-Type":"application/json"}),w.end(JSON.stringify({error:"读取文件失败"}))}return}if("POST"===e.method){let i="";return e.on("data",e=>{i+=e.toString()}),void e.on("end",()=>{try{var t,n=JSON.parse(i);let e={};fs.existsSync(FNSTYLE_FILE_PATH)&&(t=fs.readFileSync(FNSTYLE_FILE_PATH,"utf8"),e=JSON.parse(t));var s={...e,...n};fs.writeFileSync(FNSTYLE_FILE_PATH,JSON.stringify(s,null,2),"utf8"),w.writeHead(200,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!0,message:"文件更新成功"}))}catch(e){console.error("更新fnstyle.json文件出错:",e),w.writeHead(500,{"Content-Type":"application/json"}),w.end(JSON.stringify({error:"更新文件失败"}))}})}}if("/api/exit"===r&&"POST"===e.method){d=e.headers["x-auth-token"];if(d&&"authenticated"===d){systemStatus.ready=!1;try{w.writeHead(200,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!0,message:"程序将自动重启以生效..."})),setTimeout(()=>{applyConfig()},100)}catch(e){console.error("退出程序出错:",e),w.writeHead(500,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!1,message:"退出程序失败"}))}}else w.writeHead(401,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!1,message:"未授权"}))}else if("/api/check-password-file"===r&&"GET"===e.method)try{if(fs.existsSync(PW_FILE_PATH))try{var v=JSON.parse(fs.readFileSync(PW_FILE_PATH,"utf8")),j=v&&"string"==typeof v.password&&0<v.password.length;w.writeHead(200,{"Content-Type":"application/json"}),w.end(JSON.stringify({hasPasswordFile:j}))}catch(e){w.writeHead(200,{"Content-Type":"application/json"}),w.end(JSON.stringify({hasPasswordFile:!1}))}else w.writeHead(200,{"Content-Type":"application/json"}),w.end(JSON.stringify({hasPasswordFile:!1}))}catch(e){console.error("检查密码文件错误:",e),w.writeHead(500,{"Content-Type":"application/json"}),w.end(JSON.stringify({hasPasswordFile:!1,error:"服务器内部错误"}))}else if("/api/restore-default-icon"===r&&"GET"===e.method)sysicoApi.handleRestoreDefaultIcon(e,w,__dirname);else if("/api/backup-icon"===r&&"GET"===e.method)sysicoApi.handleBackupIcon(e,w,__dirname);else if("/api/upload-icon"===r&&"POST"===e.method)sysicoApi.handleUploadIcon(e,w,__dirname);else if("/api/sync-icons"===r&&"GET"===e.method)sysicoApi.syncIcons(e,w,__dirname);else if("/api/delete-sysico-file"===r&&"GET"===e.method)sysicoApi.handleDeleteSysicoFile(e,w,__dirname);else if("/api/update-theme-file"===r&&"POST"===e.method){let s="";e.on("data",e=>{s+=e}),void e.on("end",async()=>{try{var e=JSON.parse(s).themeUrl;if(e){var t=path.join(fndata,"theme.json");let l=(o,c)=>new Promise((s,i)=>{let r=c+".tmp";if(fs.existsSync(r))try{fs.unlinkSync(r)}catch(e){console.error("清理旧临时文件失败:",e)}try{let e;try{if(e=new URL(o),!["http:","https:"].includes(e.protocol))return void i(new Error("无效的URL协议，只支持http和https"))}catch(e){return void i(new Error("无效的URL格式: "+e.message))}var a="https:"===e.protocol?require("https"):require("http");let n=fs.createWriteStream(r),t=a.get(o,{headers:{Accept:"application/json, text/plain, */*","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"},timeout:1e4},e=>{[301,302,303,307,308].includes(e.statusCode)&&e.headers.location?(n.close(),fs.existsSync(r)&&fs.unlinkSync(r),l(e.headers.location,c).then(s).catch(i)):200!==e.statusCode?(n.close(),fs.existsSync(r)&&fs.unlinkSync(r),i(new Error("下载失败: "+e.statusCode))):(e.pipe(n),n.on("finish",()=>{if(n.close(),0===fs.statSync(r).size)fs.unlinkSync(r),i(new Error("下载的文件为空"));else try{var e=fs.readFileSync(r,"utf8"),t=JSON.parse(e);Array.isArray(t)?(fs.renameSync(r,c),fs.chmodSync(c,420),s({success:!0})):(fs.unlinkSync(r),i(new Error("下载的JSON内容格式不符合预期，应为数组")))}catch(e){fs.existsSync(r)&&fs.unlinkSync(r),i(new Error("下载的文件不是有效的JSON: "+e.message))}}))});t.on("error",e=>{if(n.close(),fs.existsSync(r))try{fs.unlinkSync(r)}catch(e){console.error("清理临时文件失败:",e)}console.error("下载请求出错:",e),i(new Error("下载出错: "+e.message))}),t.on("timeout",()=>{if(t.destroy(),n.close(),fs.existsSync(r))try{fs.unlinkSync(r)}catch(e){console.error("清理临时文件失败:",e)}i(new Error("下载请求超时"))})}catch(e){if(console.error("处理下载请求异常:",e),fs.existsSync(r))try{fs.unlinkSync(r)}catch(e){console.error("清理临时文件失败:",e)}i(new Error("处理下载请求出错: "+e.message))}});var n=await l(e,t);w.writeHead(200,{"Content-Type":"application/json"}),w.end(JSON.stringify(n))}else w.writeHead(400,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!1,message:"缺少必要参数themeUrl"}))}catch(e){console.error("更新主题文件错误:",e),w.writeHead(500,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!1,message:e.message||"服务器内部错误"}))}})}else if("/api/initialize-password"===r&&"POST"===e.method){let n="";e.on("data",e=>{n+=e.toString()}),void e.on("end",()=>{try{var e,t=JSON.parse(n).password;t&&"string"==typeof t?t.length<6||20<t.length?(w.writeHead(200,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!1,message:"密码长度应为6-20位"}))):(ensureDirectoryExists(path.dirname(PW_FILE_PATH)),e=simpleEncrypt(t),fs.writeFileSync(PW_FILE_PATH,JSON.stringify({password:e}),"utf8"),w.writeHead(200,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!0,message:"密码初始化成功"}))):(w.writeHead(200,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!1,message:"密码不能为空"})))}catch(e){console.error("初始化密码错误:",e),w.writeHead(500,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!1,message:"服务器内部错误"}))}})}else if("/api/login"===r&&"POST"===e.method){let t="";e.on("data",e=>{t+=e.toString()}),void e.on("end",()=>{try{var e=JSON.parse(t).password;fs.existsSync(PW_FILE_PATH)?e===simpleDecrypt(JSON.parse(fs.readFileSync(PW_FILE_PATH,"utf8")).password)?(w.writeHead(200,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!0,message:"登录成功"}))):(w.writeHead(401,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!1,message:"密码错误"}))):(w.writeHead(200,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!1,message:"密码文件不存在，请初始化密码"})))}catch(e){console.error("登录请求处理错误:",e),w.writeHead(500,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!1,message:"服务器错误"}))}})}else{if("/api/get-favicon"===r)return(p=a.searchParams.get("url"))?(y=getFaviconUrl(p)).primary?((h=e=>{(e.startsWith("https")?require("https"):require("http")).get(e,e=>{if(200!==e.statusCode)return!1;var t=path.join(__dirname,"temp");ensureDirectoryExists(t);let n=path.join(t,`favicon_${Date.now()}.ico`),s=fs.createWriteStream(n);return e.pipe(s),s.on("finish",()=>{s.close();var e=fs.readFileSync(n);fs.unlinkSync(n),w.writeHead(200,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!0,faviconData:e.toString("base64")}))}),!0}).on("error",()=>!1)})(y.primary),y.secondary&&h(y.secondary),w.writeHead(200,{"Content-Type":"application/json"}),void w.end(JSON.stringify({success:!1,message:"无法获取favicon"}))):(w.writeHead(400,{"Content-Type":"application/json"}),void w.end(JSON.stringify({success:!1,message:"无效的URL"}))):(w.writeHead(400,{"Content-Type":"application/json"}),void w.end(JSON.stringify({success:!1,message:"缺少URL参数"})));if("/api/download-file"===r)if("POST"===e.method){let i="";e.on("data",e=>{i+=e.toString()}),e.on("end",()=>{try{var n,s;let{fileUrl:e,fileName:t}=JSON.parse(i);e&&t?(s=(ensureDirectoryExists(n=path.join(fndata,"fnstyle")),path.join(n,t)),downloadFileFromUrl(e,s).then(()=>{var e="/deskdata/fnstyle/"+t;w.writeHead(200,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!0,path:e,fileName:t}))}).catch(e=>{console.error("下载文件时出错:",e),w.writeHead(500,{"Content-Type":"application/json"}),w.end(JSON.stringify({error:"下载文件失败: "+e.message}))})):(w.writeHead(400,{"Content-Type":"application/json"}),w.end(JSON.stringify({error:"缺少必要参数"})))}catch(e){console.error("处理下载请求时出错:",e),w.writeHead(500,{"Content-Type":"application/json"}),w.end(JSON.stringify({error:"服务器内部错误: "+e.message}))}})}else w.writeHead(405,{"Content-Type":"application/json"}),w.end(JSON.stringify({error:"不支持的请求方法"}));else if("/api/select-theme"===r)if("POST"===e.method){let s="";e.on("data",e=>{s+=e.toString()}),e.on("end",()=>{try{var{loginLogoUrl:e,loginBackgroundUrl:t,deviceLogoUrl:n,desktopWallpaperUrl:o}=JSON.parse(s);if(e&&t&&n&&o){var c=path.join(fndata,"fnstyle");ensureDirectoryExists(c);let s="loginLogo"+path.extname(e.split("?")[0]),i="loginBackground"+path.extname(t.split("?")[0]),r="deviceLogo"+path.extname(n.split("?")[0]),a="desktopWallpaper"+path.extname(o.split("?")[0]);var l=[downloadFileFromUrl(e,path.join(c,s)),downloadFileFromUrl(t,path.join(c,i)),downloadFileFromUrl(n,path.join(c,r)),downloadFileFromUrl(o,path.join(c,a))];Promise.all(l).then(()=>{var e={loginLogo:"/deskdata/fnstyle/"+s,loginBackground:"/deskdata/fnstyle/"+i,deviceLogo:"/deskdata/fnstyle/"+r,desktopWallpaper:"/deskdata/fnstyle/"+a};let t={};fs.existsSync(FNSTYLE_FILE_PATH)&&(n=fs.readFileSync(FNSTYLE_FILE_PATH,"utf8"),t=JSON.parse(n));var n={...t,...e};fs.writeFileSync(FNSTYLE_FILE_PATH,JSON.stringify(n,null,2),"utf8"),w.writeHead(200,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!0,message:"主题选择成功",data:e}))}).catch(e=>{console.error("下载主题文件时出错:",e),w.writeHead(500,{"Content-Type":"application/json"}),w.end(JSON.stringify({error:"下载主题文件失败: "+e.message}))})}else w.writeHead(400,{"Content-Type":"application/json"}),w.end(JSON.stringify({error:"缺少必要的URL参数"}))}catch(e){console.error("处理主题选择请求时出错:",e),w.writeHead(500,{"Content-Type":"application/json"}),w.end(JSON.stringify({error:"服务器内部错误: "+e.message}))}})}else w.writeHead(405,{"Content-Type":"application/json"}),w.end(JSON.stringify({error:"不支持的请求方法"}));else if("/api/config"===r)w.writeHead(200,{"Content-Type":"application/json"}),w.end(JSON.stringify({version:process.env.TRIM_APPVER||"未知",appName:"飞牛桌面管理工具",wizard_lan_url:process.env.wizard_lan_url||"",wizard_wan_url:process.env.wizard_wan_url||"",wizard_fndesk_index:process.env.wizard_fndesk_index||""}));else if("/api/latest-version"===r)w.setHeader("Access-Control-Allow-Origin","*"),w.setHeader("Content-Type","text/plain; charset=utf-8"),require("https").get("https://fndesk.imcq.top/?get=ver",e=>{let t="";e.on("data",e=>{t+=e}),e.on("end",()=>{w.writeHead(200),w.end(t)})}).on("error",e=>{console.error("获取最新版本号失败:",e.message),w.writeHead(500),w.end("0.0.0")});else if("/api/generate-fndesk-app"===r&&"POST"===e.method){m=e.headers["x-auth-token"];if(!m||"authenticated"!==m)return w.writeHead(401,{"Content-Type":"application/json"}),void w.end(JSON.stringify({success:!1,message:"请先登录"}));let t="";e.on("data",e=>{t+=e.toString()}),void e.on("end",()=>{try{var{appName:n,appType:r,appDefaultUrl:a,appPublicUrl:o}=JSON.parse(t);if(n&&r&&a){var c=path.join(__dirname,"fndesk_app"),l=path.join(c,"app","ui"),f=path.join(l,"images");ensureDirectoryExists(c),ensureDirectoryExists(l),ensureDirectoryExists(f);let s=Date.now().toString(),i=`/cgi/ThirdParty/fndesk_${s}/index.cgi`,e=!1,t=null;if(/^\d+/.test(a)){var d=a.match(/^(\d+)(.*)$/);i=d?(t=d[1],d[2]||"/"):a,e=!0}else{let e="http",t="",n="http",s="";if(a)if(a.startsWith("/"))e="http",t=a;else try{var p=new URL(a);e=p.protocol.replace(":",""),t=p.host+p.pathname+p.search+p.hash}catch(e){}if(o)try{var y=new URL(o);n=y.protocol.replace(":",""),s=y.host+y.pathname+y.search+y.hash}catch(e){console.warn(`无效外网URL: ${o}，使用默认值`)}(t||s)&&(i+=`?uH1=${encodeURIComponent(e)}&uB1=${encodeURIComponent(t)}&uH2=${encodeURIComponent(n)}&uB2=`+encodeURIComponent(s))}var h=`appname               = fndesk_${s}
version               = 0.1
display_name          = fndesk_${n}
desc                  = 这是由 飞牛桌面管理工具 生成的 飞牛原生桌面APP图标
arch                  = x86_64
source                = thirdparty
maintainer            = 米恋泥
maintainer_url        = https://github.com/IMGZCQ/fndesk
distributor           = 米恋泥
distributor_url       = https://club.fnnas.com/forum.php?mod=viewthread&tid=41336
desktop_uidir         = ui
desktop_applaunchname = fndesk_${s}.Application`,m=`{
	".url": {
		"fndesk_${s}.Application": {
			"title": "${n}",
			"icon": "images/icon_{0}.png",
			"type": "${r}",
${e?`			"port": "${t}",`:""}
			"url": "${i}",
			"allUsers": false,
			"control": {
				"accessPerm": "editable",
				"portPerm": "editable",
				"pathPerm": "editable"
			}
		}
	}
}`,g=path.join(c,"manifest"),u=(fs.writeFileSync(g,h,"utf8"),fs.chmodSync(g,420),path.join(l,"config")),S=(fs.writeFileSync(u,m,"utf8"),fs.chmodSync(u,420),require("child_process")).exec;S("appcenter-cli install-local > /dev/null 2>&1",{cwd:c},(e,t,n)=>{e&&console.error("执行appcenter-cli install-local命令失败:",e),n&&console.error("appcenter-cli install-local命令错误输出:",n),t&&console.log("appcenter-cli install-local命令输出:",t),w.writeHead(200,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!0,message:"飞牛原生图标生成成功",timestamp:s}))})}else w.writeHead(400,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!1,message:"缺少必需参数：appName, appType, appDefaultUrl"}))}catch(e){console.error("生成飞牛原生图标失败:",e),w.writeHead(500,{"Content-Type":"application/json"}),w.end(JSON.stringify({success:!1,message:"生成飞牛原生图标失败: "+e.message}))}})}else serveStaticFile(e,w,r)}}}}function requiresAuthentication(e){var t=path.extname(e);return!["/login.html","/favicon.ico"].includes(e)&&![".css",".js",".png",".jpg",".jpeg",".gif",".ico",".woff",".woff2",".ttf"].includes(t)}function serveStaticFile(e,n,t){var s=decodeURIComponent(t);let i=path.join(__dirname,"/"===s?process.env.wizard_fndesk_index||"index.html":s);if(t.startsWith("/api/")&&!t.startsWith("/api/login")&&!t.startsWith("/api/check-password-file")&&!t.startsWith("/api/initialize-password")&&!t.startsWith("/api/update-data")){s=e.headers["x-auth-token"];if(!s||"authenticated"!==s)return n.writeHead(401,{"Content-Type":"application/json"}),void n.end(JSON.stringify({success:!1,message:"请先登录"}))}fs.exists(i,e=>{e?fs.readFile(i,(e,t)=>{if(e)n.writeHead(500,{"Content-Type":"text/plain"}),n.end("500 Internal Server Error");else{let e="text/plain";switch(path.extname(i)){case".html":e="text/html";break;case".js":e="application/javascript";break;case".css":e="text/css";break;case".json":e="application/json";break;case".png":e="image/png";break;case".jpg":case".jpeg":e="image/jpeg";break;case".gif":e="image/gif";break;case".ico":e="image/x-icon";break;case".svg":e="image/svg+xml";break;case".woff":e="application/font-woff";break;case".woff2":e="application/font-woff2";break;case".ttf":e="application/font-ttf"}n.writeHead(200,{"Content-Type":e}),n.end(t,"utf8")}}):(n.writeHead(404,{"Content-Type":"text/plain"}),n.end("404 Not Found"))})}function checkPortAvailability(n){let s=require("net");return new Promise(t=>{let e=s.createServer();e.once("error",e=>{e.code,t(!1)}),e.once("listening",()=>{e.close(()=>{t(!0)})}),e.listen(n)})}async function getAvailablePort(e){let t=e;for(;;){if(await checkPortAvailability(t))return t;console.log(`${getBeijingTime()}端口 ${t} 已被占用，尝试端口 `+(t+1)),t++}}function updateFrontendApi(){try{readData()}catch(e){console.error("更新前端API调用失败:",e)}}async function startServer(){var e=require("httpolyglot");let n=require("fs"),s=require("path");var t=process.env.wizard_app_port||9990;let i=null,r=!1,a="";var o,c=s.join(fndata,"ssl","server.key"),l=s.join(fndata,"ssl","server.crt");if(n.existsSync(c)&&n.existsSync(l))try{i={key:n.readFileSync(c),cert:n.readFileSync(l)},r=!0,a="用户证书"}catch(e){console.error("自定义证书加载失败，尝试使用飞牛证书:",e.message)}if(!r)try{let t="/usr/trim/var/trim_connect/ssls/fnOS";if(n.existsSync(t))for(o of n.readdirSync(t).filter(e=>n.statSync(s.join(t,e)).isDirectory())){var f=s.join(t,o,"fnOS.key"),d=s.join(t,o,"fnOS.crt");if(n.existsSync(f)&&n.existsSync(d))try{i={key:n.readFileSync(f),cert:n.readFileSync(d)},r=!0,a="飞牛证书";break}catch(e){console.error(`飞牛证书 ${o} 加载失败，尝试下一个证书:`,e.message)}}}catch(e){console.error("使用飞牛证书时发生错误:",e.message)}let p=await getAvailablePort(t),y=e.createServer(i,handleApiRequest);await new Promise(t=>{y.listen(p,function(){r?(console.log(`${getBeijingTime()}服务器已启动，请使用HTTP/HTTPS的 ${p} 端口访问`),console.log(`${getBeijingTime()}HTTPS服务器已启动(${a})请使用HTTPS的 ${p} 端口访问`)):(console.log(`${getBeijingTime()}HTTP服务器已启动，请使用HTTP的 ${p} 端口访问`),console.log(getBeijingTime()+"未找到有效的SSL证书，HTTPS服务器未启动"),console.log(getBeijingTime()+"(把证书请放deskdata/ssl目录(server.crt和server.key)后重启程序即可)")),t()}),y.on("error",function(e){"EADDRINUSE"===e.code?(console.error(`错误: 端口 ${p} 已被占用，尝试端口 `+(p+1)),p++,y.listen(p)):(console.error("服务器错误:",e),t())})}),updateTargetPort(p),ensureDirectoryExists(IMG_DIR_PATH),ensurePasswordFile(),updateFrontendApi();try{var h=s.join(process.env.TRIM_APPDEST,"server","deskdata","fnstyle"),m=s.join(fndata,"fnstyle");if(n.existsSync(m)&&n.statSync(m).isDirectory()){let e=!1;try{n.lstatSync(h),e=!0}catch(e){}if(e)try{n.unlinkSync(h)}catch(e){console.error("删除旧软链接失败:",e.message)}n.symlinkSync(m,h)}}catch(e){console.error("创建软链接失败:",e.message)}}function applyConfig(){console.log(getBeijingTime()+"开始初始化配置...");var t=require("adm-zip");let n=path.join(fn_www);var s=path.join(n,"deskdata"),i=path.join(fn_res);let r=path.join(i,"tow");var a=path.join(i,"www.zip"),i=path.join(i,"www.bak");try{var o,c=path.join(r,"assets"),l=(fs.existsSync(s)&&fs.existsSync(c)||(ensureDirectoryExists(r),fs.existsSync(n)&&fs.readdirSync(n).forEach(e=>{var t=path.join(n,e),e=path.join(r,e);fs.lstatSync(t).isDirectory()?(fs.cpSync(t,e,{recursive:!0}),fs.chmodSync(e,493)):(fs.copyFileSync(t,e),fs.chmodSync(e,420))})),path.join(fndata));let e="cqfndesk_L.js";try{fs.existsSync(FNSTYLE_FILE_PATH)&&(o=JSON.parse(fs.readFileSync(FNSTYLE_FILE_PATH,"utf8")))&&o.ui_style&&(e=o.ui_style)}catch(e){console.error("读取fnstyle.json失败: "+e.message)}var f=path.join(__dirname,e),d=path.join(fndata,"HDicons.zip"),p=(fs.existsSync(d)&&fs.unlinkSync(d),ensureDirectoryExists(r),path.join(r,"deskdata")),y=(fs.existsSync(l)&&(fs.cpSync(l,p,{recursive:!0,filter:e=>{e=path.basename(e);return"pw.json"!==e&&"theme.json"!==e}}),setPermissionsRecursively(p)),path.join(r,"cqfndesk.js")),h=(fs.existsSync(f)&&(fs.copyFileSync(f,y),fs.chmodSync(y,420)),path.join(__dirname,"click.mp3")),m=path.join(fndata,"click.mp3"),g=(fs.existsSync(h)&&(fs.copyFileSync(h,m),fs.chmodSync(m,420)),path.join(__dirname,"right.mp3")),u=path.join(fndata,"right.mp3");fs.existsSync(g)&&(fs.copyFileSync(g,u),fs.chmodSync(u,420));try{let o=path.join(fndata,"sysico");if(fs.existsSync(o)){var S=fs.readdirSync(o);let r=[],a=[];S.forEach(t=>{try{var e,n,s,i=path.join(o,t);fs.statSync(i).isDirectory()||(e=path.join(fn_res,"tow","static","app","icons",t),n=path.join(e,"icon.png"),s=path.join(e,"icon.bak"),fs.existsSync(e)||fs.mkdirSync(e,{recursive:!0}),!fs.existsSync(s)&&fs.existsSync(n)&&(fs.copyFileSync(n,s),fs.chmodSync(s,420)),fs.copyFileSync(i,n),fs.chmodSync(n,420),r.push(t))}catch(e){console.error(`同步文件${t}失败:`,e),a.push({filename:t,reason:e.message})}})}}catch(e){console.error("同步图标失败:",e)}!fs.existsSync(i)&&fs.existsSync(a)?fs.renameSync(a,i):fs.existsSync(i);var w,v,j=path.join(r,"index.html"),A=path.join(n,"index.html"),T=(fs.existsSync(j)&&(modifyHtmlFile(j)?safeChmod(j,420):console.log("res/tow/index.html修改失败")),fndesk_share_page(),fndesk_Xplan_set(),fs.existsSync(r)&&((w=new t).addLocalFolder(r,""),w.writeZip(a),safeChmod(a,420)),fs.existsSync(l)&&(v=path.join(n,"deskdata"),fs.cpSync(l,v,{recursive:!0}),setPermissionsRecursively(v)),path.join(n,"cqfndesk.js"));fs.existsSync(f)&&(fs.copyFileSync(f,T),safeChmod(T,420)),fs.existsSync(A)&&modifyHtmlFile(A)&&safeChmod(A,420),copyIconsDirectory(),handleMoveNameDisplay(),console.log(getBeijingTime()+"配置应用完成！")}catch(e){console.error("应用配置时出错:",e),console.log("错误已记录，程序将继续执行...")}systemStatus.ready=!0}if(require.main===module){console.log(""),console.log(`------------- - ${getBeijingTime()}-------------`),startServer();let e=path.join(process.env.TRIM_APPDEST_VOL,"@appshare",process.env.TRIM_APPNAME,"update");if(fs.existsSync(e))try{fs.rmSync(e,{recursive:!0,force:!0})}catch(e){}console.log(getBeijingTime()+"服务器已启动，开始后台执行系统配置...");try{let t=readData();if(Array.isArray(t)&&0<t.length){let i={"序号":"fndata_Sort","类型":"fndata_Type","归属":"fndata_For","标题":"fndata_Title","外网跳转URL":"fndata_Wan","内网跳转URL":"fndata_Lan","备用URL1":"fndata_URL1","备用URL2":"fndata_URL2","备用URL3":"fndata_URL3","网络图片URL":"fndata_WanPic","本地图片URL":"fndata_LanPic"},e=t.map(e=>{var t,n,s={};for([t,n]of Object.entries(e))s[i[t]||t]=n;return s});writeData(e)}}catch(e){console.error(getBeijingTime()+"更新DATA_FILE_PATH字段名失败:",e)}let t=[path.join(fn_www,"favicon.ico"),path.join(fn_www,"index.html"),path.join(fn_www,"apps"),path.join(fn_www,"static"),path.join(fn_www,"modules"),path.join(fn_www,"assets")],n=0,s=5,i=1e3,r=()=>{var e;n++,console.log(`${getBeijingTime()}第${n}次检查飞牛系统状态...`),t.every(e=>fs.existsSync(e))?(systemStatus.ready=!0,console.log(`${getBeijingTime()}米恋泥 <飞牛桌面管理工具 v${process.env.TRIM_APPVER}> 启动...`)):n>=s?(e=t.filter(e=>!fs.existsSync(e)),console.error(`经过${s}次检查，系统状态仍未就绪，以下关键文件/目录缺失：`),e.forEach(e=>console.error("  - "+e)),console.error("系统初始化失败，退出程序！"),process.exit(1)):(0<(e=t.filter(e=>!fs.existsSync(e))).length&&(console.log("以下关键文件/目录尚未就绪，等待下次检查..."),e.forEach(e=>console.log("  - "+e))),setTimeout(r,i))};r()}function ensureDefaultImages(){let i=require("fs");var e=require("path");let r=require("https");var t=e.join(fndata,"img"),n=(i.existsSync(t)||i.mkdirSync(t,{recursive:!0}),(e,n,s)=>{if(!i.existsSync(n)){console.log(`下载默认${s}...`);let t=i.createWriteStream(n);r.get(e,e=>{e.pipe(t).on("finish",()=>{t.close(),console.log(`默认${s}下载完成`)})}).on("error",e=>{i.unlink(n,()=>{}),console.error(`下载${s}失败:`,e.message)})}});n("https://help-static.fnnas.com/images/文件管理.png",e.join(t,"f.png"),"文件夹图标"),n("https://help-static.fnnas.com/images/Margin-1.png",e.join(t,"i.png"),"图标图片")}module.exports={startServer:startServer,readData:readData,writeData:writeData,ensureDefaultImages:ensureDefaultImages},ensureDefaultImages();