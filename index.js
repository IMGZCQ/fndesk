let data=[],filteredData=[],currentPage=1,pageSize=10,editingId=null,loginStatusChecked=!1;function checkAndShowAnnouncement(){var e=(new Date).toDateString();localStorage.getItem("lastAnnouncementDate")!==e&&(setTimeout(()=>{var e=document.getElementById("announcementModal");e&&(e.classList.remove("hidden"),"function"==typeof fetchAnnouncementContent)&&fetchAnnouncementContent()},500),localStorage.setItem("lastAnnouncementDate",e))}function showNotification(e,t="success",a=!1){let n=document.createElement("div");n.className="tech-notification";var o={success:{bgColor:"linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(2, 132, 199, 0.2))",borderColor:"#06b6d4",glowColor:"0 0 15px rgba(6, 182, 212, 0.7)",icon:"âœ“"},error:{bgColor:"linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(202, 38, 38, 0.2))",borderColor:"#ef4444",glowColor:"0 0 15px rgba(239, 68, 68, 0.7)",icon:"âœ—"},info:{bgColor:"linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.2))",borderColor:"#3b82f6",glowColor:"0 0 15px rgba(59, 130, 246, 0.7)",icon:"â„¹"}},t=o[t]||o.success,o=(Object.assign(n.style,{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%) scale(0.9)",padding:"18px 26px",borderRadius:"12px",background:t.bgColor,color:"white",fontSize:"16px",fontWeight:"600",fontFamily:'-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',boxShadow:"0 10px 30px rgba(0, 0, 0, 0.2), "+t.glowColor,backdropFilter:"blur(12px)",WebkitBackdropFilter:"blur(12px)",border:"2px solid "+t.borderColor,zIndex:"9999",opacity:"0",transition:"all 0.5s cubic-bezier(0.4, 0, 0.2, 1)",display:"flex",alignItems:"center",gap:"12px",minWidth:"280px",textAlign:"center"}),document.createElement("div")),d=(Object.assign(o.style,{width:"40px",height:"40px",borderRadius:"50%",background:`radial-gradient(circle, ${t.borderColor}22, transparent 70%)`,display:"flex",alignItems:"center",justifyContent:"center",fontSize:"20px",fontWeight:"bold",border:`2px solid ${t.borderColor}88`,flexShrink:"0"}),o.textContent=t.icon,document.createElement("div"));d.textContent=e,Object.assign(d.style,{flexGrow:"1",lineHeight:"1.4"}),n.appendChild(o),n.appendChild(d),document.body.appendChild(n);let i=document.createElement("style");return i.textContent=`
        @keyframes techPulse {
            0% { box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2), ${t.glowColor}; }
            50% { box-shadow: 0 10px 35px rgba(0, 0, 0, 0.25), ${t.glowColor}, 0 0 25px ${t.borderColor}66; }
            100% { box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2), ${t.glowColor}; }
        }
    `,document.head.appendChild(i),setTimeout(()=>{n.style.opacity="1",n.style.transform="translate(-50%, -50%) scale(1)",n.style.animation="techPulse 2s infinite ease-in-out"},10),a||setTimeout(()=>{n.style.opacity="0",n.style.transform="translate(-50%, -50%) scale(0.85) translateY(-10px)",n.style.animation="none",setTimeout(()=>{n.parentNode&&document.body.removeChild(n),document.head.removeChild(i)},500)},2e3),n}let originalFetch=window.fetch;function checkLoginStatus(){var e="true"===localStorage.getItem("isLoggedIn"),t=localStorage.getItem("loginTimestamp"),a=(new Date).getTime();return!e||!t||18e5<a-parseInt(t)?(localStorage.removeItem("isLoggedIn"),localStorage.removeItem("authToken"),localStorage.removeItem("loginTimestamp"),localStorage.setItem("returnUrl",window.location.href),!(window.location.href="login.html")):(localStorage.setItem("isLoggedIn","true"),localStorage.setItem("authToken","authenticated"),!0)}window.fetch=function(e,t={}){var a;return e.startsWith("./api/")&&"./api/login"!==e&&"./api/check-password-file"!==e&&"./api/initialize-password"!==e&&(a=localStorage.getItem("authToken"))&&(t.headers=t.headers||{},"string"==typeof t.headers?t.headers+="\nX-Auth-Token: "+a:t.headers["X-Auth-Token"]=a),originalFetch(e,t).then(e=>401===e.status?(localStorage.removeItem("isLoggedIn"),localStorage.removeItem("authToken"),window.location.href="login.html",Promise.reject(new Error("æœªæˆæƒ"))):e)};let dataTableBody=document.getElementById("dataTableBody"),addBtn=document.getElementById("addBtn"),editModal=document.getElementById("editModal"),deleteModal=document.getElementById("deleteModal"),closeModal=document.getElementById("closeModal"),cancelEditBtn=document.getElementById("cancelEditBtn"),saveBtn=document.getElementById("saveBtn"),cancelDeleteBtn=document.getElementById("cancelDeleteBtn"),confirmDeleteBtn=document.getElementById("confirmDeleteBtn"),filterType=document.getElementById("filterType"),filterOwner=document.getElementById("filterOwner"),filterKeyword=document.getElementById("filterKeyword"),filterBtn=document.getElementById("filterBtn"),resetFilterBtn=document.getElementById("resetFilterBtn"),prevPage=document.getElementById("prevPage"),nextPage=document.getElementById("nextPage"),startItem=document.getElementById("startItem"),endItem=document.getElementById("endItem"),totalItems=document.getElementById("totalItems"),notification=document.getElementById("notification"),notificationMessage=document.getElementById("notificationMessage"),notificationIcon=document.getElementById("notificationIcon"),closeNotification=document.getElementById("closeNotification"),applyConfigModal=document.getElementById("applyConfigModal"),cancelApplyBtn=document.getElementById("cancelApplyBtn"),confirmApplyBtn=document.getElementById("confirmApplyBtn"),logoutModal=document.getElementById("logoutModal"),cancelLogoutBtn=document.getElementById("cancelLogoutBtn"),confirmLogoutBtn=document.getElementById("confirmLogoutBtn"),announcementModal=document.getElementById("announcementModal"),closeAnnouncementBtn=document.getElementById("closeAnnouncementBtn"),closeAnnouncementFooterBtn=document.getElementById("closeAnnouncementFooterBtn"),announcementBtn=document.getElementById("announcementBtn");function logout(){logoutModal.classList.remove("hidden")}function confirmLogout(){try{localStorage.removeItem("isLoggedIn"),localStorage.removeItem("authToken"),window.location.href="login.html"}catch(e){console.error("é€€å‡ºç™»å½•å¤±è´¥:",e),window.location.href="login.html"}}async function init(){var e,t,a;checkLoginStatus()&&((e=localStorage.getItem("pageSize"))&&(pageSize="all"===e?1/0:parseInt(e)),setupEventListeners(),initPageSizeSelector(),await loadData(),e=localStorage.getItem("filterType"),t=localStorage.getItem("filterOwner"),a=localStorage.getItem("filterKeyword"),e&&(filterType.value=e),t&&(filterOwner.value=t),a&&(filterKeyword.value=a),applyFilters())}function initPageSizeSelector(){if(document.getElementById("pageSizeSelector")){let e=document.getElementById("pageSizeSelector");void(e.value=pageSize===1/0?"all":pageSize)}else{var t=prevPage.parentElement,a=document.createElement("div");a.className="flex items-center ml-auto",a.innerHTML=`
        <span class="text-sm text-gray-600 mr-2">æ¯é¡µæ˜¾ç¤ºï¼š</span>
        <select id="pageSizeSelector" class="text-sm border rounded px-2 py-1 focus:outline-none focus:ring-1 focus:ring-primary">
            <option value="10">10æ¡</option>
            <option value="20">20æ¡</option>
            <option value="50">50æ¡</option>
            <option value="100">100æ¡</option>
            <option value="all">å…¨éƒ¨</option>
        </select>
    `,t.appendChild(a);let e=document.getElementById("pageSizeSelector");e.value=pageSize===1/0?"all":pageSize,e.addEventListener("change",handlePageSizeChange)}}function handlePageSizeChange(){var e=document.getElementById("pageSizeSelector").value;pageSize="all"===e?1/0:parseInt(e),localStorage.setItem("pageSize",pageSize===1/0?"all":pageSize),currentPage=1,renderTable(),updatePagination()}async function loadData(){try{var e=await fetch("./api/data",{headers:{"x-auth-token":"authenticated","Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"},cache:"no-store"});if(e.ok){var t=await e.json();if(Array.isArray(t))return 0<(data=t).length&&(data.sort((e,t)=>parseInt(e.fndata_Sort)-parseInt(t.fndata_Sort)),data.forEach(e=>{void 0===e.fnAppicon&&(e.fnAppicon=0)})),void generateDropdownOptions()}data=[],generateDropdownOptions(),showNotification("æ— æ•°æ®ï¼Œåˆå§‹åŒ–ä¸ºç©ºæ•°ç»„","info")}catch(e){console.error("åŠ è½½æ•°æ®å¤±è´¥:",e),showNotification("åŠ è½½æ•°æ®å¤±è´¥: "+e.message,"error"),data=[],generateDropdownOptions()}}function applyFilters(){(filteredData=data.filter(e=>{if(""!==filterType.value&&e.fndata_Type!==parseInt(filterType.value))return!1;if(filterOwner.value&&e.fndata_For!==parseInt(filterOwner.value))return!1;if(filterKeyword.value){let t=filterKeyword.value.toLowerCase();if(!Object.values(e).some(e=>null!=e&&String(e).toLowerCase().includes(t)))return!1}return!0})).sort((e,t)=>{e=parseInt(e.fndata_Sort),t=parseInt(t.fndata_Sort);return"asc"===sortDirection?e-t:t-e}),localStorage.setItem("filterType",filterType.value),localStorage.setItem("filterOwner",filterOwner.value),localStorage.setItem("filterKeyword",filterKeyword.value),currentPage=1,renderTable(),updatePagination()}function resetFilters(){filterType.value="",filterOwner.value="",filterKeyword.value="",localStorage.removeItem("filterType"),localStorage.removeItem("filterOwner"),localStorage.removeItem("filterKeyword"),applyFilters()}let sortDirection=localStorage.getItem("sortDirection")||"asc";function toggleSort(){sortDirection="asc"===sortDirection?"desc":"asc",localStorage.setItem("sortDirection",sortDirection),applyFilters()}let draggedItem=null,draggedElement=null,isDragging=!1,addDragDropStyles=()=>{var e;document.getElementById("drag-drop-styles")||((e=document.createElement("style")).id="drag-drop-styles",e.textContent=`
            /* è¡¨æ ¼æ ·å¼ä¼˜åŒ– */
            table {
                width: 100%;
                border-collapse: collapse;
            }
            
            /* æ ‡é¢˜æ ç¾åŒ– */
            thead {
                background: #20213dff;
                color: white;
            }
            
            thead th {
                text-align: center;
                font-size: 16px;
                font-weight: 600;
                padding: 12px 8px;
                border-bottom: 2px solid #e5e7eb;
                transition: all 0.3s ease;
            }
            
            thead th:hover {
                background-color: #374151;
                transform: translateY(-1px);
            }
            
            /* è¡¨æ ¼å†…å®¹å±…ä¸­ */
            tbody td {
                text-align: center;
                vertical-align: middle;
            }
            
            /* æ“ä½œåˆ—ä¿æŒåŸæ ·å¼ä½†å±…ä¸­ */
            tbody td.text-center {
                text-align: center;
            }
            
            /* æ‹–æ”¾æ»‘å—æ ·å¼ - ç§‘æŠ€æ„Ÿè®¾è®¡ */
            .drag-handle {
                cursor: grab;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: 36px;
                height: 36px;
                color: #58aadaff;
                transition: all 0.3s ease;
                border: 1px solid #4749afff;
                border-radius: 6px;
                box-shadow: 0 2px 8px rgba(79, 70, 229, 0.1);
                position: relative;
                overflow: hidden;
            }
            .drag-handle::before {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 100%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(79, 70, 229, 0.2), transparent);
                transition: left 0.5s;
            }
            .drag-handle:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 16px rgba(79, 70, 229, 0.25);
                border-color: #4338CA;
                color: #4338CA;
            }
            .drag-handle:hover::before {
                left: 100%;
            }
            .drag-handle:active {
                cursor: grabbing;
                transform: translateY(0);
                box-shadow: 0 2px 8px rgba(79, 70, 229, 0.2);
            }
            .drag-handle:active {
                cursor: grabbing;
            }
            
            /* æ‹–åŠ¨æ—¶çš„æ ·å¼ */
            .dragging {
                opacity: 0.5;
                background-color: #181952ff !important;
            }
            
            /* æ‹–åŠ¨æ—¶çš„å ä½ç¬¦ */
            .drag-placeholder {
                background-color: #e5e7eb;
                border: 2px dashed #9ca3af;
                height: 60px;
                border-radius: 4px;
            }
            
            /* æ‹–æ‹½è¡Œçš„ä¸´æ—¶å…ƒç´  - æ”¹ä¸ºåŠé€æ˜ */
            .drag-ghost {
                position: fixed;
                pointer-events: none;
                opacity: 0.9;
                z-index: 9999;
                background-color: rgba(33, 83, 150, 0.68);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                border-radius: 4px;
            }
        `,document.head.appendChild(e))};function initDragDrop(){addDragDropStyles(),document.querySelectorAll(".drag-handle").forEach(e=>{e.addEventListener("mousedown",handleMouseDown),e.addEventListener("touchstart",handleTouchStart,{passive:!0})}),dataTableBody.addEventListener("dragover",handleDragOver),dataTableBody.addEventListener("dragenter",handleDragEnter),dataTableBody.addEventListener("drop",handleDrop),document.addEventListener("mousemove",handleMouseMove),document.addEventListener("mouseup",handleMouseUp),document.addEventListener("touchmove",handleTouchMove,{passive:!1}),document.addEventListener("touchend",handleTouchEnd)}function handleMouseDown(e){e.preventDefault();var t=e.target.closest("tr");t&&startDragging(t,e.clientX,e.clientY)}function handleTouchStart(e){var t=e.target.closest("tr");t&&0!==e.touches.length&&startDragging(t,(t=e.touches[0]).clientX,t.clientY)}function startDragging(e,a,n){try{var o,d=e.querySelector("td:nth-child(2)");if(d){let t=parseInt(d.textContent);(draggedItem=data.find(e=>e.id===t))&&(draggedElement=e,isDragging=!0,e.classList.add("dragging"),e.setAttribute("draggable","true"),(o=e.cloneNode(!0)).className="drag-ghost",o.style.width=e.offsetWidth+"px",document.body.appendChild(o),updateGhostPosition(a,n,o),e._dragData={ghostElement:o,startX:a,startY:n,startTime:(new Date).toISOString()})}}catch(e){isDragging=!1}}function updateGhostPosition(e,t,a){var n=a.offsetWidth/2,o=a.offsetHeight/2;a.style.left=e-n+"px",a.style.top=t-o+"px"}function handleMouseMove(e){if(isDragging&&draggedElement)try{var t;draggedElement._dragData&&draggedElement._dragData.ghostElement&&(t=draggedElement._dragData.ghostElement,updateGhostPosition(e.clientX,e.clientY,t),handleAutoScroll(e.clientY))}catch(e){}}function handleTouchMove(e){if(isDragging&&draggedElement&&(e.preventDefault(),0!==e.touches.length)){var t,e=e.touches[0];try{draggedElement._dragData&&draggedElement._dragData.ghostElement&&(t=draggedElement._dragData.ghostElement,updateGhostPosition(e.clientX,e.clientY,t),handleAutoScroll(e.clientY))}catch(e){}}}function handleAutoScroll(e){e<50?window.scrollBy(0,-5):e>window.innerHeight-50&&window.scrollBy(0,5)}function handleMouseUp(e){if(isDragging)try{var t=document.elementFromPoint(e.clientX,e.clientY);t&&t.closest("tr");handleDrop(new MouseEvent("drop",{clientX:e.clientX,clientY:e.clientY,bubbles:!0,cancelable:!0}))}catch(e){endDragging()}}function handleTouchEnd(e){if(isDragging&&draggedElement)try{handleDrop(e)}catch(e){endDragging()}}function endDragging(){if(draggedElement)try{if(draggedElement.classList.remove("dragging"),draggedElement.removeAttribute("draggable"),draggedElement._dragData&&draggedElement._dragData.ghostElement)try{document.body.removeChild(draggedElement._dragData.ghostElement)}catch(e){}delete draggedElement._dragData,draggedItem=null,draggedElement=null,isDragging=!1,document.querySelectorAll(".drag-placeholder").forEach(e=>{try{e.remove()}catch(e){}})}catch(e){draggedItem=null,draggedElement=null,isDragging=!1}}function handleDragOver(e){if(e.preventDefault(),e.stopPropagation(),isDragging)try{var t,a=findTargetRow(e);a&&a!==draggedElement&&!a.classList.contains("drag-placeholder")&&(document.querySelectorAll(".drag-placeholder").forEach(e=>{e.remove()}),(t=document.createElement("tr")).className="drag-placeholder",t.innerHTML='<td colspan="8"></td>',isBefore(draggedElement,a)?a.parentNode.insertBefore(t,a):a.parentNode.insertBefore(t,a.nextSibling))}catch(e){}}function handleDragEnter(e){e.preventDefault()}async function handleDrop(e){if(e.preventDefault(),e.stopPropagation(),isDragging&&draggedItem&&draggedElement){e=findTargetRow(e);if(!e||e===draggedElement||e.classList.contains("drag-placeholder"))endDragging();else try{var a=e.querySelector("td:nth-child(2)");if(a){var n=a.textContent.trim();let t=parseInt(n);if(isNaN(t))showNotification("æ’åºå¤±è´¥ï¼šç›®æ ‡é¡¹IDæ— æ•ˆ","error");else{var o=data.find(e=>e.id===t);if(o){var d=parseInt(draggedItem.fndata_Sort),i=parseInt(o.fndata_Sort);if(d!==i)if(await reorderItems(d,i))try{await loadData();var r=localStorage.getItem("filterType"),l=localStorage.getItem("filterOwner"),s=localStorage.getItem("filterKeyword");r&&(filterType.value=r),l&&(filterOwner.value=l),s&&(filterKeyword.value=s),applyFilters()}catch(e){showNotification("æ’åºæˆåŠŸï¼Œä½†åˆ·æ–°è¡¨æ ¼å¤±è´¥","warning")}else showNotification("æ’åºæ“ä½œå¤±è´¥","error")}else showNotification("æ’åºå¤±è´¥ï¼šæ‰¾ä¸åˆ°ç›®æ ‡é¡¹æ•°æ®","error")}}else showNotification("æ’åºå¤±è´¥ï¼šæ‰¾ä¸åˆ°ç›®æ ‡é¡¹ä¿¡æ¯","error")}catch(e){showNotification("æ’åºå¤±è´¥ï¼Œè¯·é‡è¯•","error")}finally{endDragging()}}else endDragging()}function findTargetRow(e){let t,a;var n;if(e.changedTouches&&0<e.changedTouches.length?(n=e.changedTouches[0],t=n.clientX,a=n.clientY):e.touches&&0<e.touches.length?(n=e.touches[0],t=n.clientX,a=n.clientY):void 0!==e.clientX&&void 0!==e.clientY&&(t=e.clientX,a=e.clientY),void 0===t||void 0===a)return null;try{var o=document.elementFromPoint(t,a);return o?o.closest("tr"):null}catch(e){return null}}function isBefore(t,a){if(t.parentNode===a.parentNode)for(let e=t;e;e=e.previousSibling)if(e===a)return!1;return!0}async function reorderItems(n,o){try{if(n=parseInt(n),o=parseInt(o),n!==o){let t=data.find(e=>parseInt(e.fndata_Sort)===n),a=data.find(e=>parseInt(e.fndata_Sort)===o);if(!t||!a)return!1;var d=[...data].sort((e,t)=>parseInt(e.fndata_Sort)-parseInt(t.fndata_Sort)),i=d.findIndex(e=>e.id===t.id),r=d.findIndex(e=>e.id===a.id);if(-1===i||-1===r)return!1;if(r<i){var e=t.fndata_Sort;t.fndata_Sort=a.fndata_Sort;for(let e=r;e<i;e++){var l=d[e],s=d[e+1];s.id!==t.id&&(l.fndata_Sort=s.fndata_Sort)}0<i&&(d[i-1].fndata_Sort=e)}else{var c=t.fndata_Sort;t.fndata_Sort=a.fndata_Sort;for(let e=r;e>i;e--){var g=d[e],p=d[e-1];p.id!==t.id&&(g.fndata_Sort=p.fndata_Sort)}i<d.length-1&&(d[i+1].fndata_Sort=c)}await saveDataToFile()||(localStorage.setItem("deskData",JSON.stringify(data)),showNotification("æ’åºå·²æ›´æ–°ï¼Œä½†æ•°æ®åŒæ­¥å¯èƒ½éœ€è¦æ‰‹åŠ¨åˆ·æ–°","warning"))}return!0}catch(e){}}function renderTable(){var e=pageSize===1/0?filteredData:filteredData.slice((currentPage-1)*pageSize,currentPage*pageSize),t=document.querySelector("#sortable-order i");t&&(t.className="asc"===sortDirection?"fa fa-sort-asc ml-1":"fa fa-sort-desc ml-1"),dataTableBody.innerHTML="",0===e.length?((t=document.createElement("tr")).innerHTML=`
            <td colspan="9" class="px-4 py-8 text-center text-gray-500">
                <i class="fa fa-search-minus text-2xl mb-2"></i>
                <p>æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è®°å½•</p>
            </td>
        `,dataTableBody.appendChild(t)):(e.forEach(t=>{var e=document.createElement("tr"),a=(e.className="border-b border-gray-200 transition-all-300",["fndata_Wan","fndata_Lan","fndata_URL1","fndata_URL2","fndata_URL3"]),n=["fndata_Wan","fndata_Lan","fndata_URL1","fndata_URL2","fndata_URL3"],o=[];for(let e=0;e<a.length;e++)t[a[e]]&&t[a[e]].trim()&&o.push({label:n[e],url:t[a[e]]});let d="",i=(0<(s=o.length)&&o.forEach(({label:e,url:t})=>{d+=`<div style="margin-bottom: 6px; white-space: nowrap;">
                    <span style="color: #3B82F6; font-weight: 600; margin-right: 8px;">${e}:</span>
                    <a href="${t}" target="_blank" style="color: #FFFFFF; text-decoration: none; white-space: nowrap;" 
                       onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">
                        ${t}
                    </a>
                </div>`}),""),r=(0===t.fndata_Type||"0"===t.fndata_Type?i=0<s?`
                <div style="position: relative; display: inline-block;">
                    <!-- è§¦å‘å…ƒç´  - åªæ˜¾ç¤ºé“¾æ¥æ•°é‡ -->
                    <span style="color: #3B82F6; cursor: pointer; font-weight: 500;">${s}ä¸ªé“¾æ¥</span>
                    
                    <!-- æ‚¬æµ®æ¡† - è°ƒæ•´margin-topä¸º0ï¼Œç¡®ä¿é¼ æ ‡å¯ä»¥å¹³æ»‘ç§»åŠ¨åˆ°æµ®çª— -->
                    <div style="position: absolute; left: 0; top: 100%; margin-top: -5px; 
                                z-index: 9999; background: #161630b0; border: 1px solid #303644; 
                                border-radius: 6px; padding: 12px; min-width: 100px; max-width: 720px; 
                                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5); opacity: 0.95; 
                                backdrop-filter: blur(8px); white-space: nowrap; 
                                visibility: hidden; opacity: 0; transition: visibility 0s, opacity 0.2s ease-in-out;">
                        ${d}
                    </div>
                    
                    <style>
                        /* ç¡®ä¿çˆ¶å®¹å™¨æ‚¬æµ®æ—¶æµ®çª—ä¿æŒå¯è§ï¼Œè§£å†³é¼ æ ‡ç§»åŠ¨é—®é¢˜ */
                        div[style*="position: relative; display: inline-block;"]:hover > div {
                            visibility: visible !important;
                            opacity: 0.95 !important;
                        }
                        /* å¢åŠ çˆ¶å®¹å™¨çš„æœ€å°å®½åº¦ï¼Œç¡®ä¿é¼ æ ‡ç§»åŠ¨è·¯å¾„ */
                        div[style*="position: relative; display: inline-block;"] {
                            min-width: 60px;
                        }
                    </style>
                </div>`:'<span class="text-gray-400">ç„¡é“¾æ¥</span>':1!==t.fndata_Type&&"1"!==t.fndata_Type||(i='<span style="font-size: 26px;">ğŸ“</span>'),'<div class="flex space-x-1 whitespace-nowrap items-center" style="justify-content: center;">');t.fndata_LanPic?(s=encodeURI(t.fndata_LanPic),r+=`<img src="${s}" alt="${s}" style="height: 56px; width: 56px; object-fit: cover;" class="rounded" title="${s}">`):r+='<div style="height: 56px; width: 56px;" class="bg-gray-100 rounded flex items-center justify-center text-gray-400"><i class="fa fa-file-image-o"></i></div>',r+="</div>";var l,s=typeNumberToText(t.fndata_Type);let c="æ¡Œé¢";0!==t.fndata_For&&(l=data.find(e=>e.id===t.fndata_For),c=l?l.fndata_Title:t.fndata_For),e.innerHTML=`
            <td class="px-4 py-3 whitespace-nowrap">
                <div class="drag-handle" title="åºå·: ${t.fndata_Sort}">
                    <i class="fa fa-align-justify"></i>
                </div>
            </td>
            <td class="px-4 py-3 whitespace-nowrap hidden">${t.id}</td>
            <td class="px-4 py-3 text-center" style="display: flex; align-items: center; justify-content: center; min-height: 80px;">
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <label class="switch switch-green" onclick="event.stopPropagation();" title="è®¾ç½®æ­¤å›¾æ ‡çš„å¯ç”¨/ç¦ç”¨">
                        <input type="checkbox" value="" ${1===t.enable||void 0===t.enable?"checked":""} data-id="${t.id}" onchange="toggleEnable(this)">
                        <span class="slider"></span>
                    </label>
                    ${1!==t.fndata_Type&&t.fndata_Type,""}
                </div>
            </td>
            <td class="px-4 py-3 font-medium" style="color: #FFC107; font-size: 16px;" title="æ­¤å›¾æ ‡çš„å”¯ä¸€ID: ${t.id}">${t.fndata_Title}</td>
            <td class="px-4 py-3 whitespace-nowrap">${i}</td>
            <td class="px-4 py-3 whitespace-nowrap">${1===t.fndata_Type||"1"===t.fndata_Type?'<span style="font-size: 26px;color: #ff4444ff; font-weight: 500;">ğŸ“</span>':1===t.OpenInPage?'<span style="font-size: 24px;">ğŸ“ƒ</span><span style="color: #f57474ff; font-weight: 500;">é¡µå†…</span>':'<span style="font-size: 24px;">ğŸš€</span><span style="color: #f76ccdff; font-weight: 500;">æ–°çª—</span>'}</td>
            <td class="px-4 py-3 whitespace-nowrap">${r}</td>
            <td class="px-4 py-3 whitespace-nowrap" style="color: ${0===t.fndata_Type||"0"===t.fndata_Type?"#aaeeffff":"#fff9a3ff"}; font-weight: 500;">
                <span class="px-2 py-1 text-xs rounded-full ${getTypeColorClass(t.fndata_Type)}">
                    ${0===t.fndata_Type||"0"===t.fndata_Type?'<span style="font-size: 22px;">ğŸ“Œ</span>':'<span style="font-size: 22px;">ğŸ“</span>'}
                    ${s}
                </span>
            </td>
            <td class="px-4 py-3 whitespace-nowrap" style="color: ${0===t.fndata_For||"0"===t.fndata_For?"#FFFFFF":"#aab0ffff"}; font-weight: 500;">${c}</td>
            <td class="px-4 py-3 whitespace-nowrap text-center">
                <button class="edit-btn" data-id="${t.id}">
                    æ”¹
                </button>
                <button class="delete-btn" data-id="${t.id}">
                    åˆ 
                </button>
            </td>
        `,dataTableBody.appendChild(e)}),document.querySelectorAll(".edit-btn").forEach(e=>{e.addEventListener("click",()=>editRecord(e.getAttribute("data-id")))}),document.querySelectorAll(".delete-btn").forEach(e=>{e.addEventListener("click",()=>confirmDelete(e.getAttribute("data-id")))}),initDragDrop())}function toggleEnable(t){let a=parseInt(t.getAttribute("data-id")),n=data.find(e=>e.id===a);n&&(n.enable=t.checked?1:0,saveDataToFile().then(()=>{showNotification(t.checked?"å·²å¯ç”¨è¯¥å›¾æ ‡":"å·²ç¦ç”¨è¯¥å›¾æ ‡","success")}).catch(e=>{console.error("ä¿å­˜æ•°æ®å¤±è´¥:",e),showNotification("ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•","error"),t.checked=!t.checked,n.enable=t.checked?1:0}))}function toggleFnAppicon(t){let a=parseInt(t.getAttribute("data-id")),n=data.find(e=>e.id===a);n&&(n.fnAppicon=t.checked?1:0,saveDataToFile().then(()=>{showNotification(t.checked?"å·²å¯ç”¨é£ç‰›å›¾æ ‡":"å·²ç¦ç”¨é£ç‰›å›¾æ ‡","success")}).catch(e=>{console.error("ä¿å­˜æ•°æ®å¤±è´¥:",e),showNotification("ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•","error"),t.checked=!t.checked,n.fnAppicon=t.checked?1:0}))}function typeNumberToText(e){return 0===e||"0"===e?"å›¾æ ‡":"æ–‡ä»¶å¤¹"}function getTypeColorClass(e){return{0:"bg-purple-100 text-purple-800",1:"bg-cyan-100 text-cyan-800"}[parseInt(e)]||"bg-gray-100 text-gray-800"}function generateDropdownOptions(){let a=document.getElementById("filterType"),n=document.getElementById("filterOwner");for(var e=a.value,t=n.value;1<a.options.length;)a.remove(1);[{value:"0",text:"å›¾æ ‡"},{value:"1",text:"æ–‡ä»¶å¤¹"}].forEach(e=>{var t=document.createElement("option");t.value=e.value,t.textContent=e.text,a.appendChild(t)});let o=document.getElementById("editfndata_For");for(;1<n.options.length;)n.remove(1);o.innerHTML="";var d=document.createElement("option");d.value="0",d.textContent="æ¡Œé¢",o.appendChild(d);let i=data.filter(e=>1===e.fndata_Type&&void 0!==e.id);i.forEach(e=>{var t=document.createElement("option");t.value=e.id,t.textContent=e.fndata_Title+"_id:"+e.id,o.appendChild(t)});d=document.createElement("option");d.value="0",d.textContent="æ¡Œé¢",n.appendChild(d);let r=new Set;data.forEach(e=>{void 0!==e.fndata_For&&""!==e.fndata_For&&null!==e.fndata_For&&0!==e.fndata_For&&r.add(e.fndata_For)}),r.forEach(t=>{var e=document.createElement("option"),a=(e.value=t,i.find(e=>e.id===t));e.textContent=a?a.fndata_Title:t,n.appendChild(e)});try{a.value=e,n.value=t}catch(e){console.log("éƒ¨åˆ†ç­›é€‰é€‰é¡¹ä¸å­˜åœ¨ï¼Œæ— æ³•å®Œå…¨æ¢å¤é€‰æ‹©çŠ¶æ€")}}function updatePagination(){var e=filteredData.length,t=pageSize===1/0?1:Math.ceil(e/pageSize),a=0<e?(currentPage-1)*(pageSize===1/0?e:pageSize)+1:0,n=Math.min(currentPage*(pageSize===1/0?e:pageSize),e);startItem.textContent=a,endItem.textContent=n,totalItems.textContent=e,prevPage.disabled=1===currentPage,nextPage.disabled=currentPage===t,pageSize===1/0&&(prevPage.disabled=!0,nextPage.disabled=!0)}function toggleUrlFields(e){var t=document.getElementById("publicUrlField"),a=document.getElementById("urlFieldsRow1"),n=document.getElementById("urlFieldsRow2"),o=document.getElementById("imageUrlsContainer");t&&(t.style.display=""),a&&(a.style.display=e?"grid":"none"),n&&(n.style.display=e?"grid":"none"),o&&o.classList.remove("hidden")}function initTypeSelectionListener(){var e=document.getElementById("editfndata_Type");e&&!e._hasChangeListener&&(e._hasChangeListener=!0,e.addEventListener("change",function(){window.toggleUrlFieldsByType?window.toggleUrlFieldsByType():toggleUrlFields("0"===this.value)}))}function openAddModal(){document.getElementById("modalTitle").textContent="æ·»åŠ è®°å½•",editingId=null,document.getElementById("recordId").value="",document.getElementById("editForm").reset();var e=0<data.length?Math.max(...data.map(e=>parseInt(e.fndata_Sort))):0;document.getElementById("editfndata_Sort").value=e+100,document.getElementById("editOpenInPage").value="0",document.getElementById("editfndata_Type").disabled=!1,initTypeSelectionListener();let t=document.getElementById("editfndata_Type");setTimeout(()=>{window.toggleUrlFieldsByType?window.toggleUrlFieldsByType():(toggleUrlFields("0"===t.value),(e=document.querySelector(".input-group:has(#editOpenInPage)"))&&(e.style.display="flex"));var e=document.getElementById("dockerContainerSelect");e&&(e.value="")},100),editModal.classList.remove("hidden"),setTimeout(()=>{var e=document.getElementById("editfndata_LanPic")?.value;window.updateImagePreview&&window.updateImagePreview(e||"")},100)}function editRecord(e){let t=parseInt(e),a=data.find(e=>e.id===t);var n;a&&(document.getElementById("modalTitle").textContent="ç¼–è¾‘è®°å½•",editingId=e,document.getElementById("recordId").value=e,Object.keys(a).forEach(e=>{var t=document.getElementById("edit"+e);t&&(t.value=a[e])}),e=document.getElementById("editfndata_For"),n=a.fndata_For,generateDropdownOptions(),e.value=null!=n&&""!==n?n:"0",document.getElementById("editfndata_Type").disabled=!0,initTypeSelectionListener(),setTimeout(()=>{document.getElementById("editfndata_Type")&&window.toggleUrlFieldsByType&&window.toggleUrlFieldsByType();var e=document.getElementById("dockerContainerSelect");e&&(e.value="")},100),editModal.classList.remove("hidden"),setTimeout(()=>{var e=document.getElementById("editfndata_LanPic")?.value;e&&window.updateImagePreview&&window.updateImagePreview(e)},100))}function confirmDelete(e){let t=parseInt(e);var a=data.find(e=>e.id===t);a&&(document.getElementById("deleteId").value=e,document.getElementById("deleteTitle").textContent=`"${a.fndata_Title}"`,deleteModal.classList.remove("hidden"))}async function downloadAndSetLocalImage(e,t,a,n){try{if(checkLoginStatus()){var o=[],d=document.getElementById("editå¤–ç½‘è·³è½¬URL").value,i=document.getElementById("editå†…ç½‘è·³è½¬URL").value,r=document.getElementById("editå¤‡ç”¨URL1").value,l=document.getElementById("editå¤‡ç”¨URL2").value,s=document.getElementById("editå¤‡ç”¨URL3").value,c=(d&&o.push(d),i&&o.push(i),r&&o.push(r),l&&o.push(l),s&&o.push(s),await fetch("./api/download-image",{method:"POST",headers:{"Content-Type":"application/json","x-auth-token":"authenticated"},body:JSON.stringify({id:e,title:t,imageUrl:a,urls:o,type:n})})),g=await c.json();if(401===c.status)localStorage.removeItem("isLoggedIn"),window.location.href="login.html";else{if(g.success&&g.filePath)return console.log("å›¾ç‰‡ä¸‹è½½æˆåŠŸï¼Œæœ¬åœ°è·¯å¾„:",g.filePath),g.filePath;console.log("å›¾ç‰‡ä¸‹è½½å¤±è´¥:",g.message)}}return null}catch(e){return console.error("ä¸‹è½½å›¾ç‰‡å¤±è´¥:",e),null}}async function saveRecord(){if(checkLoginStatus())try{var a=document.getElementById("editfndata_Title").value;if(a.trim()){var n,o=document.getElementById("editfndata_WanPic").value,d=parseInt(document.getElementById("editfndata_Type").value);let e,t=(e=editingId?parseInt(editingId):(0<data.length?Math.max(...data.map(e=>e.id)):0)+1,document.getElementById("editfndata_LanPic").value);if(t&&(t.startsWith("http://")||t.startsWith("https://")))try{showNotification("æ­£åœ¨ä¸‹è½½ç½‘ç»œå›¾ç‰‡ï¼Œè¯·ç¨å€™...","info");var i=await(await fetch("./api/download-image",{method:"POST",headers:{"Content-Type":"application/json","x-auth-token":"authenticated"},body:JSON.stringify({id:e,title:a,imageUrl:t,urls:[],type:d,setPermissions:!0,overwrite:!0})})).json();i.success&&i.filePath&&(t=i.filePath,document.getElementById("editfndata_LanPic").value=t,showNotification("ç½‘ç»œå›¾ç‰‡ä¸‹è½½æˆåŠŸï¼","success"))}catch(e){console.error("ä¸‹è½½ç½‘ç»œå›¾ç‰‡å¤±è´¥:",e),showNotification("ä¸‹è½½ç½‘ç»œå›¾ç‰‡å¤±è´¥ï¼Œå°†ç»§ç»­ä½¿ç”¨åŸå§‹URL","warning")}o&&""!==o.trim()||t&&""!==t.trim()||(showNotification("ç½‘ç»œå›¾ç‰‡URLå’Œæœ¬åœ°å›¾ç‰‡URLéƒ½ä¸ºç©ºï¼Œæ­£åœ¨å°è¯•è‡ªåŠ¨è·å–å›¾ç‰‡...","info"),await autoFetchImage(),t=document.getElementById("editfndata_LanPic").value),t&&""!==t.trim()||(n=0===d?"/deskdata/img/i.png":"/deskdata/img/f.png",t=n,console.log("æœªè·å–åˆ°å›¾ç‰‡ï¼Œä½¿ç”¨é»˜è®¤å›¾ç‰‡: "+n));var r={fndata_Sort:parseInt(document.getElementById("editfndata_Sort").value),fndata_Type:d,fndata_For:parseInt(document.getElementById("editfndata_For").value),OpenInPage:parseInt(document.getElementById("editOpenInPage").value),fndata_Title:a,fndata_Wan:document.getElementById("editfndata_Wan").value,fndata_Lan:document.getElementById("editfndata_Lan").value,fndata_URL1:document.getElementById("editfndata_URL1").value,fndata_URL2:document.getElementById("editfndata_URL2").value,fndata_URL3:document.getElementById("editfndata_URL3").value,fndata_WanPic:o,fndata_LanPic:t,enable:editingId?data.find(e=>e.id===parseInt(editingId))?.enable??1:1,fnAppicon:editingId?data.find(e=>e.id===parseInt(editingId))?.fnAppicon??0:0};if(editingId){let t=e;var l=data.findIndex(e=>e.id===t);-1!==l&&(data[l]={...data[l],...r}),showNotification("è®°å½•æ›´æ–°æˆåŠŸï¼","success")}else data.push({id:e,...r}),showNotification("è®°å½•æ·»åŠ æˆåŠŸï¼","success");await saveDataToFile(),localStorage.removeItem("deskData"),data.sort((e,t)=>parseInt(e.fndata_Sort)-parseInt(t.fndata_Sort)),generateDropdownOptions(),applyFilters(),editModal.classList.add("hidden")}else showNotification("æ ‡é¢˜ä¸ºå¿…å¡«é¡¹ï¼Œè¯·è¾“å…¥æ ‡é¢˜","info"),document.getElementById("editfndata_Title").focus()}catch(e){showNotification("ä¿å­˜å¤±è´¥: "+e.message,"error"),console.error("ä¿å­˜å¤±è´¥:",e)}}async function deleteRecord(){if(checkLoginStatus())try{let t=parseInt(document.getElementById("deleteId").value);var e=data.find(e=>e.id===t);data=(data=e&&1===e.fndata_Type?data.map(e=>e.fndata_For===t?{...e,fndata_For:0}:e):data).filter(e=>e.id!==t),await saveDataToFile();0===data.length&&localStorage.removeItem("deskData"),deleteModal.classList.add("hidden"),(0===data.length?(filteredData=[],renderTable(),updatePagination(),generateDropdownOptions):(data.sort((e,t)=>parseInt(e.fndata_Sort)-parseInt(t.fndata_Sort)),generateDropdownOptions(),applyFilters))(),showNotification("è®°å½•åˆ é™¤æˆåŠŸï¼","success")}catch(e){showNotification("åˆ é™¤å¤±è´¥: "+e.message,"error"),console.error("åˆ é™¤å¤±è´¥:",e)}}async function saveDataToFile(){try{var e=await fetch("./api/data",{method:"POST",headers:{"Content-Type":"application/json","x-auth-token":"authenticated"},body:JSON.stringify(data)});if(!e.ok){if(401===e.status)return localStorage.removeItem("isLoggedIn"),!(window.location.href="login.html");throw new Error("ä¿å­˜æ•°æ®å¤±è´¥")}var t=await e.json();if(t.success)return!0;throw new Error(t.message||"ä¿å­˜æ•°æ®å¤±è´¥")}catch(e){console.error("ä¿å­˜æ•°æ®å¤±è´¥:",e);try{return localStorage.setItem("deskData",JSON.stringify(data)),!0}catch(e){return console.error("æœ¬åœ°ä¿å­˜ä¹Ÿå¤±è´¥:",e),!1}}}function setupEventListeners(){checkAndShowAnnouncement(),addBtn.addEventListener("click",openAddModal);var e=document.getElementById("menuLogout"),e=(e&&e.addEventListener("click",logout),document.getElementById("menuMergeData")),e=(e&&e.addEventListener("click",()=>{window.location.href="otn.html"}),document.getElementById("menuResetDesktop")),e=(e&&(e.addEventListener("click",async()=>{document.getElementById("resetDesktopModal").classList.remove("hidden")}),document.getElementById("cancelResetBtn").addEventListener("click",()=>{document.getElementById("resetDesktopModal").classList.add("hidden")}),document.getElementById("confirmResetBtn").addEventListener("click",async()=>{try{var e,t,a=document.createElement("iframe");a.id="loadingIframe",a.src="./loading.html",a.style.cssText=`
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         border: none;
         z-index: 9999;
     `,document.body.appendChild(a),document.getElementById("resetDesktopModal").classList.add("hidden"),(await(await fetch("./api/check-file",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({filePath:"/usr/trim/share/.restore/www.bak"})})).json()).exists?(e=await fetch("./api/reset-desktop",{method:"POST",headers:{"Content-Type":"application/json"}}),await fetch("./api/update-data",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({filePath:"deskdata/pw.json",update:{enabled:0}})}),(t=await e.json()).success?showNotification("ç³»ç»Ÿè¿˜åŸæˆåŠŸï¼Œè¯·ç¨ååˆ·æ–°æ¡Œé¢ã€‚","success"):showNotification("è¿˜åŸå¤±è´¥ï¼š"+(t.error||"æœªçŸ¥é”™è¯¯"),"error")):showNotification("ç³»ç»Ÿæºæ–‡ä»¶ä¸å­˜åœ¨ï¼","error")}catch(e){console.error("è¿˜åŸæ¡Œé¢æ—¶å‡ºé”™:",e),showNotification("è¿˜åŸè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç³»ç»Ÿæƒé™ã€‚","error")}})),document.getElementById("applyBtn")),e=(e&&e.addEventListener("click",()=>{applyConfigModal.classList.remove("hidden")}),confirmApplyBtn&&confirmApplyBtn.addEventListener("click",async()=>{try{var e=document.createElement("iframe");e.id="loadingIframe",e.src="./loading.html",e.style.cssText=`
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         border: none;
         z-index: 9999;
     `,document.body.appendChild(e),applyConfigModal.classList.add("hidden"),await fetch("./api/update-data",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({filePath:"deskdata/pw.json",update:{enabled:1}})});var t=await(await fetch("./api/exit",{method:"POST",headers:{"Content-Type":"application/json"}})).json();t.success?showNotification("ç³»ç»Ÿé…ç½®å³å°†å¼€å§‹...","success"):alert(t.message||"é€€å‡ºç¨‹åºå¤±è´¥ï¼")}catch(e){console.error("é€€å‡ºç¨‹åºæ—¶å‡ºé”™ï¼š",e),alert("é€€å‡ºç¨‹åºå¤±è´¥ï¼š"+e.message)}}),cancelApplyBtn&&cancelApplyBtn.addEventListener("click",()=>{applyConfigModal.classList.add("hidden")}),closeModal.addEventListener("click",()=>editModal.classList.add("hidden")),cancelEditBtn.addEventListener("click",()=>editModal.classList.add("hidden")),saveBtn.addEventListener("click",saveRecord),document.getElementById("editForm")),t=(e.addEventListener("submit",e=>{e.preventDefault(),saveRecord()}),cancelDeleteBtn.addEventListener("click",()=>deleteModal.classList.add("hidden")),confirmDeleteBtn.addEventListener("click",deleteRecord),cancelLogoutBtn&&cancelLogoutBtn.addEventListener("click",()=>logoutModal.classList.add("hidden")),confirmLogoutBtn&&confirmLogoutBtn.addEventListener("click",()=>{logoutModal.classList.add("hidden"),confirmLogout()}),announcementBtn&&announcementBtn.addEventListener("click",()=>{announcementModal.classList.remove("hidden")}),closeAnnouncementBtn&&closeAnnouncementBtn.addEventListener("click",()=>{announcementModal.classList.add("hidden")}),closeAnnouncementFooterBtn&&closeAnnouncementFooterBtn.addEventListener("click",()=>{announcementModal.classList.add("hidden")}),document.addEventListener("keydown",e=>{"Escape"===e.key&&(editModal.classList.contains("hidden")?deleteModal.classList.contains("hidden")?applyConfigModal.classList.contains("hidden")?logoutModal.classList.contains("hidden")?announcementModal.classList.contains("hidden")||announcementModal.classList.add("hidden"):logoutModal.classList.add("hidden"):applyConfigModal.classList.add("hidden"):deleteModal.classList.add("hidden"):editModal.classList.add("hidden"))}),document.addEventListener("mouseover",e=>{var t,a,e=e.target.closest(".group[data-row-index]");e&&(t=e.querySelector(".absolute"))&&(a=parseInt(e.getAttribute("data-row-index")),e.getBoundingClientRect(),a<3?(t.style.bottom="auto",t.style.top="calc(100% + 4px)"):(t.style.top="auto",t.style.bottom="calc(100% + 4px)"))}),filterBtn.addEventListener("click",applyFilters),resetFilterBtn.addEventListener("click",resetFilters),filterType.addEventListener("change",applyFilters),filterOwner.addEventListener("change",applyFilters),prevPage.addEventListener("click",()=>{1<currentPage&&pageSize!==1/0&&(currentPage--,renderTable(),updatePagination())}),nextPage.addEventListener("click",()=>{var e=pageSize===1/0?1:Math.ceil(filteredData.length/pageSize);currentPage<e&&pageSize!==1/0&&(currentPage++,renderTable(),updatePagination())}),document.getElementById("sortable-order")),t=(t&&t.addEventListener("click",toggleSort),document.addEventListener("keydown",e=>{"Escape"===e.key&&(editModal.classList.contains("hidden")?deleteModal.classList.contains("hidden")||deleteModal.classList.add("hidden"):editModal.classList.add("hidden"))}),filterKeyword.addEventListener("keypress",e=>{"Enter"===e.key&&applyFilters()}),document.getElementById("autoFetchBtn"));t&&t.addEventListener("click",autoFetchImage);let i=document.getElementById("localImgFileInput");e&&i&&(e.addEventListener("click",e=>{"uploadLocalImgBtn"===e.target.id&&i.click()}),i.addEventListener("change",async e=>{e=e.target.files[0];if(e){var a=document.getElementById("recordId");let t=a?a.value.trim():"";var a=document.getElementById("editfndata_LanPic"),n=document.getElementById("uploadLocalImgBtn");if(!t)try{var o=0<data.length?Math.max(...data.map(e=>e.id)):0;t=String(o+1),console.log("è‡ªåŠ¨ç”Ÿæˆçš„æ–°è®°å½•ID: "+t)}catch(e){console.error("è®¡ç®—IDæ—¶å‡ºé”™:",e),t="1"}o=new FormData;o.append("file",e),o.append("id",t);try{n&&(n.disabled=!0,n.innerHTML='<i class="fa fa-spinner fa-spin"></i> ä¸Šä¼ ä¸­...');var d=await(await fetch("./api/upload/localImg",{method:"POST",headers:{"x-auth-token":localStorage.getItem("authToken")||""},body:o})).json();if(!d.success||!d.filePath)throw new Error(d.message||"ä¸Šä¼ å¤±è´¥");a&&(a.value=d.filePath,window.updateImagePreview)&&window.updateImagePreview(d.filePath),showNotification("å›¾ç‰‡ä¸Šä¼ æˆåŠŸ","success")}catch(e){console.error("å›¾ç‰‡ä¸Šä¼ å¤±è´¥:",e),showNotification("ä¸Šä¼ å¤±è´¥: "+e.message,"error")}finally{n&&(n.disabled=!1,n.innerHTML="ä¸Šä¼ "),i.value=""}}}))}window.autoFetchImage=async function(){if(checkLoginStatus())try{var o=document.getElementById("editfndata_Title").value;if(o.trim()){var d=[],i=document.getElementById("editfndata_Wan").value;let e=document.getElementById("editfndata_Lan").value;var r=document.getElementById("editfndata_URL1").value,l=document.getElementById("editfndata_URL2").value,s=document.getElementById("editfndata_URL3").value,c=document.getElementById("editfndata_WanPic").value,g=parseInt(document.getElementById("editfndata_Type").value);e&&/^\d+$/.test(e)&&(y=new URL(window.location.href),e=y.protocol+`//${y.hostname}:`+e),i&&d.push(i),e&&d.push(e),r&&d.push(r),l&&d.push(l),s&&d.push(s);let t=showNotification("æ­£åœ¨ä¸‹è½½å›¾ç‰‡ï¼Œè¯·ç¨å€™...","info",!1);var p=new Promise((e,t)=>{setTimeout(()=>t(new Error("ä¸‹è½½è¶…æ—¶")),5e3)});let a;a=editingId?parseInt(editingId):(0<data.length?Math.max(...data.map(e=>e.id)):0)+1;var m,u=fetch("./api/download-image",{method:"POST",headers:{"Content-Type":"application/json","x-auth-token":"authenticated"},body:JSON.stringify({id:a,title:o,imageUrl:c,urls:d,type:g,isAutoFetch:!0,setPermissions:!0,overwrite:!0})}).then(async e=>{if(401===e.status)throw localStorage.removeItem("isLoggedIn"),window.location.href="login.html",new Error("æœªæˆæƒ");return await e.json()});let n=await Promise.race([u,p]);if(n.success&&n.filePath)t&&t.parentNode&&(document.body.removeChild(t),(m=document.head.querySelectorAll("style"))[m.length-1].remove()),document.getElementById("editfndata_LanPic").value=n.filePath,setTimeout(()=>{window.updateImagePreview&&window.updateImagePreview(n.filePath)},50),n.imageUrl&&(document.getElementById("editfndata_WanPic").value=n.imageUrl),showNotification("å›¾ç‰‡è·å–æˆåŠŸï¼","success");else if(1===g){var f="https://help-static.fnnas.com/images/æ–‡ä»¶ç®¡ç†.png";document.getElementById("editfndata_WanPic").value=f,document.getElementById("editfndata_LanPic").value="/deskdata/img/f.png",setTimeout(()=>{window.updateImagePreview&&window.updateImagePreview("/deskdata/img/f.png")},50);try{await fetch("./api/download-image",{method:"POST",headers:{"Content-Type":"application/json","x-auth-token":"authenticated"},body:JSON.stringify({id:"f",title:"é»˜è®¤æ–‡ä»¶å¤¹å›¾æ ‡",imageUrl:f,urls:[],type:g,forceFilename:"f.png",setPermissions:!0})}),showNotification("ä½¿ç”¨é»˜è®¤æ–‡ä»¶å¤¹å›¾æ ‡","info")}catch(e){console.error("ä¸‹è½½é»˜è®¤æ–‡ä»¶å¤¹å›¾æ ‡å¤±è´¥:",e),showNotification("ä½¿ç”¨é»˜è®¤æ–‡ä»¶å¤¹å›¾æ ‡ï¼ˆä½†ä¸‹è½½å¤±è´¥ï¼‰","warning")}}else{var h="https://help-static.fnnas.com/images/Margin-1.png";document.getElementById("editfndata_WanPic").value=h,document.getElementById("editfndata_LanPic").value="/deskdata/img/i.png",setTimeout(()=>{window.updateImagePreview&&window.updateImagePreview()},50);try{await fetch("./api/download-image",{method:"POST",headers:{"Content-Type":"application/json","x-auth-token":"authenticated"},body:JSON.stringify({id:"i",title:"é»˜è®¤å›¾æ ‡",imageUrl:h,urls:[],type:g,forceFilename:"i.png",setPermissions:!0})}),showNotification("ä½¿ç”¨é»˜è®¤å›¾æ ‡","info")}catch(e){console.error("ä¸‹è½½é»˜è®¤å›¾æ ‡å¤±è´¥:",e),showNotification("ä½¿ç”¨é»˜è®¤å›¾æ ‡ï¼ˆä½†ä¸‹è½½å¤±è´¥ï¼‰","warning")}}}else showNotification("è¯·å…ˆè¾“å…¥æ ‡é¢˜","info"),document.getElementById("editfndata_Title").focus()}catch(e){loadingNotification&&loadingNotification.parentNode&&(document.body.removeChild(loadingNotification),(y=document.head.querySelectorAll("style"))[y.length-1].remove());var y,i=parseInt(document.getElementById("editfndata_Type").value);"ä¸‹è½½è¶…æ—¶"===e.message?showNotification("ä¸‹è½½å›¾ç‰‡è¶…æ—¶ï¼Œä½¿ç”¨é»˜è®¤å›¾æ ‡","warning"):(console.error("è‡ªåŠ¨è·å–å›¾ç‰‡å¤±è´¥:",e),showNotification("è·å–å›¾ç‰‡å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å›¾æ ‡","error")),1===i?(document.getElementById("editç½‘ç»œå›¾ç‰‡URL").value="https://help-static.fnnas.com/images/æ–‡ä»¶ç®¡ç†.png",document.getElementById("editæœ¬åœ°å›¾ç‰‡URL").value="/deskdata/img/f.png"):(document.getElementById("editç½‘ç»œå›¾ç‰‡URL").value="https://help-static.fnnas.com/images/Margin-1.png",document.getElementById("editæœ¬åœ°å›¾ç‰‡URL").value="/deskdata/img/i.png")}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",init):init();