let fs=require("fs"),path=require("path"),pathMappings={deskdata:`/var/apps/${process.env.TRIM_APPNAME||"trim"}/shares/${process.env.TRIM_APPNAME||"trim"}/deskdata`,fnw:"/usr/trim/www",res:"/usr/trim/share/.restore",trimMedia:"/var/apps/trim.media/target"};function ensureDirectoryExists(e){fs.existsSync(e)||fs.mkdirSync(e,{recursive:!0})}function isPathSafe(e,s){var n=path.join(pathMappings.res,"tow","static","app","icons");return path.resolve(e).startsWith(n)}function handleRestoreDefaultIcon(e,s,n){try{var t,a,i,o,c=new URL(e.url,"http://"+e.headers.host).searchParams.get("directory");c?isPathSafe(t=path.join(pathMappings.res,"tow","static","app","icons",c),n)?(a=t,i=path.join(a,"icon.bak"),o=path.join(a,"icon.png"),fs.existsSync(i)?(fs.copyFileSync(i,o),fs.chmodSync(o,420),s.writeHead(200,{"Content-Type":"application/json"}),s.end(JSON.stringify({success:!0,message:"默认图标已恢复"}))):(s.writeHead(404,{"Content-Type":"application/json"}),s.end(JSON.stringify({success:!1,message:"未找到备份文件icon.bak"})))):(s.writeHead(403,{"Content-Type":"application/json"}),s.end(JSON.stringify({success:!1,message:"访问被拒绝"}))):(s.writeHead(400,{"Content-Type":"application/json"}),s.end(JSON.stringify({success:!1,message:"缺少directory参数"})))}catch(e){console.error("恢复默认图标失败:",e),s.writeHead(500,{"Content-Type":"application/json"}),s.end(JSON.stringify({success:!1,message:"服务器内部错误",error:e.message}))}}function handleBackupIcon(e,s,n){try{var t,a,i,o=new URL(e.url,"http://"+e.headers.host).searchParams.get("directory");o?(t=path.join(pathMappings.res,"tow","static","app","icons",o),a=path.join(t,"icon.png"),i=path.join(t,"icon.bak"),fs.existsSync(a)?(fs.existsSync(i)||(fs.copyFileSync(a,i),fs.chmodSync(i,420)),ensureDirectoryExists(path.join(pathMappings.deskdata,"sysico")),s.writeHead(200,{"Content-Type":"application/json"}),s.end(JSON.stringify({success:!0,message:"图标备份完成，可以上传新图标"}))):(s.writeHead(404,{"Content-Type":"application/json"}),s.end(JSON.stringify({success:!1,message:"未找到原始图标文件icon.png"})))):(s.writeHead(400,{"Content-Type":"application/json"}),s.end(JSON.stringify({success:!1,message:"缺少directory参数"})))}catch(e){console.error("备份图标失败:",e),s.writeHead(500,{"Content-Type":"application/json"}),s.end(JSON.stringify({success:!1,message:"服务器内部错误",error:e.message}))}}function handleUploadIcon(n,o,e){try{let i=new URL(n.url,"http://"+n.headers.host).searchParams.get("directory");if(i){var s=path.join(pathMappings.res,"tow","static","app","icons",i);if(isPathSafe(s,e)){var t=s;let a=path.join(t,"icon.png");var c=path.join(t,"icon.bak");if(fs.existsSync(c)){n.pause();let t=[];parseInt(n.headers["content-length"]||0);let s=0;n.resume(),n.on("data",e=>{s+=e.length,t.push(e),10485760<s&&n.destroy(new Error("文件大小超过限制"))}),n.on("end",()=>{try{var e=Buffer.concat(t),s=path.join(pathMappings.deskdata,"sysico"),n=(ensureDirectoryExists(s),path.join(s,""+i));fs.writeFileSync(n,e),fs.chmodSync(n,420),fs.copyFileSync(n,a),fs.chmodSync(a,420),o.writeHead(200,{"Content-Type":"application/json"}),o.end(JSON.stringify({success:!0,message:"图标上传成功"}))}catch(e){console.error("写入图标文件失败:",e),o.writeHead(500,{"Content-Type":"application/json"}),o.end(JSON.stringify({success:!1,message:"图标写入失败",error:e.message}))}}),n.on("error",e=>{console.error("接收文件数据出错:",e),o.writeHead(500,{"Content-Type":"application/json"}),o.end(JSON.stringify({success:!1,message:"接收文件数据失败",error:e.message}))})}else o.writeHead(400,{"Content-Type":"application/json"}),o.end(JSON.stringify({success:!1,message:"请先备份图标"}))}else o.writeHead(403,{"Content-Type":"application/json"}),o.end(JSON.stringify({success:!1,message:"访问被拒绝"}))}else o.writeHead(400,{"Content-Type":"application/json"}),o.end(JSON.stringify({success:!1,message:"缺少directory参数"}))}catch(e){console.error("上传图标失败:",e),o.writeHead(500,{"Content-Type":"application/json"}),o.end(JSON.stringify({success:!1,message:"服务器内部错误",error:e.message}))}}function syncIcons(e,s,p){try{let r=path.join(pathMappings.deskdata,"sysico");if(fs.existsSync(r)){var n=fs.readdirSync(r);let o=[],c=[];n.forEach(s=>{try{var e,n,t,a,i=path.join(r,s);fs.statSync(i).isDirectory()||(isPathSafe(e=path.join(pathMappings.res,"tow","static","app","icons",s),p)?(n=e,t=path.join(n,"icon.png"),a=path.join(n,"icon.bak"),ensureDirectoryExists(n),!fs.existsSync(a)&&fs.existsSync(t)&&(fs.copyFileSync(t,a),fs.chmodSync(a,420)),fs.copyFileSync(i,t),fs.chmodSync(t,420),o.push(s)):c.push({filename:s,reason:"路径安全验证失败"}))}catch(e){console.error(`同步文件${s}失败:`,e),c.push({filename:s,reason:e.message})}}),s.writeHead(200,{"Content-Type":"application/json"}),s.end(JSON.stringify({success:!0,message:`图标同步完成，成功: ${o.length}, 失败: `+c.length,successFiles:o,failedFiles:c}))}else s.writeHead(404,{"Content-Type":"application/json"}),s.end(JSON.stringify({success:!1,message:"deskdata/sysico/目录不存在"}))}catch(e){console.error("同步图标失败:",e),s.writeHead(500,{"Content-Type":"application/json"}),s.end(JSON.stringify({success:!1,message:"服务器内部错误",error:e.message}))}}function handleDeleteSysicoFile(e,s,n){try{var t,a=new URL(e.url,"http://"+e.headers.host).searchParams.get("iconId");a?(t=path.join(pathMappings.deskdata,"sysico",a),fs.existsSync(t)?(fs.unlinkSync(t),s.writeHead(200,{"Content-Type":"application/json"}),s.end(JSON.stringify({success:!0,message:"文件删除成功"}))):(s.writeHead(200,{"Content-Type":"application/json"}),s.end(JSON.stringify({success:!0,message:"文件不存在，无需删除"})))):(s.writeHead(400,{"Content-Type":"application/json"}),s.end(JSON.stringify({success:!1,message:"缺少iconId参数"})))}catch(e){console.error("删除sysico文件失败:",e),s.writeHead(500,{"Content-Type":"application/json"}),s.end(JSON.stringify({success:!1,message:e.message}))}}module.exports={handleRestoreDefaultIcon:handleRestoreDefaultIcon,handleBackupIcon:handleBackupIcon,handleUploadIcon:handleUploadIcon,syncIcons:syncIcons,handleDeleteSysicoFile:handleDeleteSysicoFile};